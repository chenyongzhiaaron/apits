# 第1次使用Compose

## 1. 术语

首先介绍几个术语

- 服务 (`service`)：一个应用容器
- 项目 (`project`)：由一组关联的应用容器组成的一个完整业务单元

可见，一个项目可以由多个服务（容器）关联而成，`Compose` 面向项目进行管理



## 2. 案例

最常见的项目是 web 网站，该项目应该包含 web 应用和数据库

下面我们用 `Python` 来建立一个能够记录页面访问次数的 web 网站

### 2.1 创建flask web 应用

新建文件夹，在该目录中编写 `app.py` 文件

```python
from flask import Flask
from redis import Redis

app = Flask(__name__)
redis = Redis(host='redis', port=6379)

@app.route('/')
def hello():
    count = redis.incr('hits')
    return 'Hello World! 该页面已被访问 {} 次。\n'.format(count)

if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=True)

```

### 2.2 编写Dockerfile

编写 `Dockerfile` 文件，内容为

```dockerfile
FROM python:3.6
ADD ./app.py /home
WORKDIR /home
RUN pip3 install redis flask -i https://mirrors.aliyun.com/pypi/simple/
CMD ["python3", "app.py"]
```

### 2.3 docker-compose.yml

编写 `docker-compose.yml` 文件，这个是 Compose 使用的主模板文件

```yaml
version: '3'
services:
  flask:
    build: .
    ports:
     - "5000:5000"
  redis:
    image: "redis"
```

## 3. 运行&测试

执行完上述步骤之后，能够看到3个文件

![image-20191126084650236](assets/image-20191126084650236.png)

### 运行 compose 项目

在当前路径下，运行如下命令

```bash
$ docker-compose up
```

![image-20191126085347786](assets/image-20191126085347786.png)

启动成功

![image-20191126085417921](assets/image-20191126085417921.png)

### 效果

此时访问本地 `5000` 端口，每次刷新页面，计数就会加 1

![image-20191119115718660](assets/image-20191119115718660.png)

结束运行方式：`ctrl+c`

![image-20191126085513011](assets/image-20191126085513011.png)

## 4. 扩展

怎样能够用宿主机的Redis客户端访问刚刚使用`docker-compose`管理的Redis容器？ 参考如下方式

修改`docker-compose.yml`

![image-20191126085908334](assets/image-20191126085908334.png)

重新运行`docker-compose up`

![image-20191126085946469](assets/image-20191126085946469.png)

使用Redis客户端链接redis容器

![image-20191126090044575](assets/image-20191126090044575.png)

![image-20191126090110602](assets/image-20191126090110602.png)