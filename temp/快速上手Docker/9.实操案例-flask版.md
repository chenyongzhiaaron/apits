# 实操案例

一步步搭建flask开发镜像

## 1. 安装Vim（ubuntu_flask:1.0）

准备工作

```shell
mkdir ubuntu_flask
cd ubuntu_flask
touch Dockerfile
```

新建`sources.list`文件内容如下：

```
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial main restricted
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-updates main restricted
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial universe
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-updates universe
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-updates multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-backports main restricted universe multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-security main restricted
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-security universe
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-security multiverse
```

`Dockerfile`文件内容如下：

```dockerfile
FROM ubuntu:16.04
COPY sources.list /etc/apt/sources.list
RUN apt-get update && apt-get install vim -y
```

运行命令：

```
docker build -t ubuntu_flask:1.0 .
```

<img src="assets/image-20201214204711492.png" alt="image-20201214204711492" style="zoom:50%;" />

结果

<img src="assets/image-20201214204739429.png" alt="image-20201214204739429" style="zoom:50%;" />

查看创建的镜像

<img src="assets/image-20201214204841206.png" alt="image-20201214204841206" style="zoom:50%;" />

使用刚刚创建的镜像 创建一个容器

```
docker run -it ubuntu_flask:1.0
```

<img src="assets/image-20201214204914234.png" alt="image-20201214204914234" style="zoom:50%;" />

可以在docker容器中使用vim了，开心中.....

<img src="assets/image-20201214204954097.png" alt="image-20201214204954097" style="zoom:50%;" />



## 2. 安装Python3(ubuntu_flask:1.1)

`Dockerfile_1.1`文件内容如下：

```dockerfile
FROM ubuntu_flask:1.0
RUN apt-get install python3 -y
```

<img src="assets/image-20201214205200471.png" alt="image-20201214205200471" style="zoom:50%;" />

运行命令：

```
docker build -t ubuntu_flask:1.1 . -f Dockerfile_1.1
```

<img src="assets/image-20201214205330968.png" alt="image-20201214205330968" style="zoom:50%;" />

效果

<img src="assets/image-20201214205350194.png" alt="image-20201214205350194" style="zoom:50%;" />



## 3. 安装pip3(ubuntu_flask:1.2)

`Dockerfile_1.2`内容如下：

```dockerfile
FROM ubuntu_flask:1.1
RUN apt-get install python3-pip -y
```

<img src="assets/image-20201214205522760.png" alt="image-20201214205522760" style="zoom:50%;" />

命令：

```
docker build -t ubuntu_flask:1.2 . -f Dockerfile_1.2
```

<img src="assets/image-20201214205619748.png" alt="image-20201214205619748" style="zoom:50%;" />

效果：

<img src="assets/image-20201214205652825.png" alt="image-20201214205652825" style="zoom:50%;" />



## 4. 安装flask需要的模块、包（ubuntu_flask:1.3）

### pip加速

清华：https://pypi.tuna.tsinghua.edu.cn/simple

阿里云：http://mirrors.aliyun.com/pypi/simple/

中国科技大学 https://pypi.mirrors.ustc.edu.cn/simple/

华中理工大学：http://pypi.hustunique.com/

山东理工大学：http://pypi.sdutlinux.org/

豆瓣：http://pypi.douban.com/simple/

### 开始构建

`requirements.txt`内容如下：（如果大家之前已经养成了用python虚拟换的好习惯，此时只需要切换虚拟环境然后pip freeze > requirements.txt就可以得到此文件，所以再次建议要用Python的虚拟环境）

```
arrow==0.17.0
certifi==2020.6.20
chardet==3.0.4
click==7.1.2
Flask==1.1.2
Flask-Sockets==0.2.1
gevent==1.5.0
gevent-websocket==0.10.1
greenlet==0.4.17
idna==2.8
iso8601==0.1.13
itsdangerous==1.1.0
Jinja2==2.11.2
leancloud==2.8.1
MarkupSafe==1.1.1
python-dateutil==2.8.1
qiniu==7.2.2
requests==2.22.0
retrying==1.3.3
secure-cookie==0.1.0
six==1.15.0
urllib3==1.25.3
Werkzeug==1.0.1
zope.event==4.5.0
zope.interface==5.2.0

```

`Dockerfile_1.3`内容如下：

```dockerfile
FROM ubuntu_flask:1.2

# 复制文件到容器
ADD requirements.txt /home

# 跳转到指定目录
WORKDIR /home

RUN pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```


命令：

```
docker build -t ubuntu_flask:1.3 . -f Dockerfile_1.3
```

<img src="assets/image-20201214210140764.png" alt="image-20201214210140764" style="zoom:50%;" />

成功效果

<img src="assets/image-20201214210432613.png" alt="image-20201214210432613" style="zoom:50%;" />



## 5. 编写测试flask项目（ubuntu_flask:1.4）

`main.py`内容如下：

```python
from flask import Flask

# 创建flask对象
app = Flask(__name__)


@app.route('/')
def index():
    """
    处理一个页面的逻辑
    :return:
    """
    return 'hello flask'


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8899, debug=True)  # 如果是127.0.0.1那么意味着只能容器本身能访问，其他电脑不行

```

`Dockerfile_1.4`内容如下：

```dockerfile
FROM ubuntu_flask:1.3

# 进入到项目目录
WORKDIR /home

# 拷贝flask示例.py到工作目录(此时的.就是/home路径的意思，因为上面已经使用WORKDIR设置了)
COPY main.py .

# 对外暴露端口
EXPOSE 8899

# 运行测试项目
CMD ["python3","main.py"]
```

命令如下：

```
docker build -t ubuntu_flask:1.4 . -f Dockerfile_1.4
```

效果：

<img src="assets/image-20201214211320382.png" alt="image-20201214211320382" style="zoom:50%;" />



## 6. 运行 & 测试

```
docker run --rm -it -p 8899:8899 ubuntu_flask:1.4
```

效果如下：

![image-20201214212206857](assets/image-20201214212206857.png)



## 7. 上传到仓库

打标签

<img src="assets/image-20201214212340558.png" alt="image-20201214212340558" style="zoom:50%;" />

上传

<img src="assets/image-20201214212441107.png" alt="image-20201214212441107" style="zoom:50%;" />



## 8. 注意

当我们通过dockerfile建立一个新的镜像之后，如果删除老镜像是删不掉的，因为新镜像在创建时依赖了它，所以解决的办法是

1. 先将新的镜像进行备份到tar文件
2. 将新、老全部删除
3. 通过docker load -i xxx.tar重新获取到之前的新镜像即可

详细过程，可以参考https://my.oschina.net/u/2937605/blog/1797218