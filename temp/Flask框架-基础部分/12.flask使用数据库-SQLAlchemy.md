# flask使用数据库-SQLAlchemy

## 1. 引入

> 上一节课，学习了在视图函数中，添加python原生操作MySQL的方式，来实现查询数据。
>
> SQL语句有很多，而且很容易出错，一丁点的地方写错了，那么意味着这个SQL语句就有问题，如果在开发的过程中经常因为SQL语句的小问题，而耽误了项目的整体进度，那么项目经理会找你“谈谈的”，你懂得

之前咱们也学习过`orm`还有印象么？

说的通俗点：就是定义一个类，对这个类的对象操作，最终它自动转化为SQL语句

对了，就是那个`SQLAlchemy`

## 2. 使用SQLAlchemy对项目进行升级

### 2.1. 定义类模型

```python
from flask import Flask
from flask import render_template
import pymysql

# 创建flask对象
app = Flask(__name__)

@app.route("/")
def index():
    """
    这个函数用来完成一个url对应的逻辑处理
    :return:
    """
    return "哈哈哈 ，我是第一个flask页面，成功的道理开始了..."

@app.route("/test")
def test():
    return "这是test页面"

@app.route("/profile")
def profile():
    """
    返回html页面数据
    :return:
    """
    # return "<h1>我是个人主页</h1>"
    with open("profile.html") as f:
        content = f.read()
    return content

@app.route("/profile_v2/<user_id>")  # <user_id>表示匹配url时，这里的数据提取出来
def profile_v2(user_id):  # 将提取出来的数据传递给<user_id>中<>内的名字，而且函数的形参也是这个名字
    return "<h1>这是%s的个人主页</h1>" % user_id

@app.route("/profile_v3/<user_id>")
def profile_v3(user_id):
    # return "<h1>这是%s的个人主页</h1>" % user_id
    # 1. 读取profile.html文件
    with open("profile.html") as f:
        content = f.read()

    # 2. 将刚刚标记的那个特殊字符串，进行替换；即将xxxx替换为user_id
    content = content.replace("xxxx", user_id)

    # 3. 将替换之后的HTML页面数据返回，浏览器就可以看到自己个人简历了
    return content

@app.route("/profile_v4/<user_id>")
def profile_v4(user_id):
    # return render_template("profile.html")
    return render_template("profile.html", xxxx=user_id)

@app.route("/profile_v5/<user_id>")
def profile_v5(user_id):
    # 1. 查询数据库
    # 1.1 创建Connection连接
    conn = pymysql.connect(host='localhost', port=3306, database='flask_1', user='root', password='123456', charset='utf8')
    # 1.2 获得Cursor对象
    cs1 = conn.cursor()
    # 1.3 构造参数列表
    params = [user_id]
    # 1.4 执行select语句，并返回受影响的行数：查询所有数据
    cs1.execute('select * from user where user_id=%s', params)
    # 1.5 获取查询的结果
    result = cs1.fetchone()
    # result = cs1.fetchall()
    print(result)
    # 1.6 关闭Cursor对象
    cs1.close()
    # 1.7 闭Connection对象
    conn.close()

    # 2. 模板渲染
    return render_template("profile.html", xxxx=user_id)

@app.route("/profile_v6/<user_id>")
def profile_v6(user_id):
    # 1. 查询数据库
    # 1.1 创建Connection连接
    conn = pymysql.connect(host='localhost', port=3306, database='flask_1', user='root', password='123456', charset='utf8')
    # 1.2 获得Cursor对象
    cs1 = conn.cursor()
    # 1.3 构造参数列表
    params = [user_id]
    # 1.4 执行select语句，并返回受影响的行数：查询所有数据
    cs1.execute('select * from user where user_id=%s', params)
    # 1.5 获取查询的结果
    result = cs1.fetchone()
    # result = cs1.fetchall()
    print(result)
    # 1.6 关闭Cursor对象
    cs1.close()
    # 1.7 闭Connection对象
    conn.close()

    # 2. 模板渲染
    return render_template("profile.html", user_name=result[2], head_img=result[3])

@app.route("/profile_v7/<user_id>")
def profile_v7(user_id):
    # 1. 查询数据库
    # 1.1 创建Connection连接
    conn = pymysql.connect(host='localhost', port=3306, database='flask_1', user='root', password='123456', charset='utf8')
    # 1.2 获得Cursor对象
    cs1 = conn.cursor()
    # 1.3 构造参数列表
    params = [user_id]
    # 1.4 执行select语句，并返回受影响的行数：查询所有数据
    cs1.execute('select * from user where user_id=%s', params)
    # 1.5 获取查询的结果
    result = cs1.fetchone()
    # result = cs1.fetchall()
    print(result)
    # 1.6 关闭Cursor对象
    cs1.close()
    # 1.7 闭Connection对象
    conn.close()

    # 2. 模板渲染
    return render_template("profile.html", user_name=result[2], head_img=result[3], short_description=result[4])


# ================= 下面是添加的代码 ===================
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, String, Integer
from sqlalchemy.orm import sessionmaker

# 链接是需要指定要用到的MySQL数据库
engine = create_engine('mysql+pymysql://root:123456@localhost:3306/flask_1?charset=utf8')
Base = declarative_base()  # 生成SQLORM基类


class User(Base):
    # 对应MySQL中数据表的名字
    __tablename__ = 'user'

    # 创建字段
    id = Column(Integer, primary_key=True)
    user_id = Column(String(50), nullable=False)
    user_name = Column(String(50), nullable=False)
    head_img = Column(String(200))
    short_description = Column(String(300))


@app.route("/profile_v8/<user_id>")
def profile_v8(user_id):
    # 1. 查询数据库
    # 创建session对象
    DBSession = sessionmaker(bind=engine)  # 创建与数据库的会话，返回的是一个类
    session = DBSession()  # 生成链接数据库的实例

    # 获取返回数据的第一行
    obj = session.query(User).filter(User.user_id == user_id).one()
    # 关闭session
    session.close()

    # 2. 模板渲染
    return render_template("profile.html", user_name=obj.user_name, head_img=obj.head_img, short_description=obj.short_description)


if __name__ == '__main__':
    app.run()

```





![image-20180813174642167](assets/image-20180813174642167.png)

#### 重启flask项目，浏览器重新访问

![image-20180813174754935](assets/image-20180813174754935.png)

## 3. 升级

### 3.1. 新建立一个python包

![image-20180813175118240](assets/image-20180813175118240.png)

![image-20180813175144353](assets/image-20180813175144353.png)

![image-20180813175252004](assets/image-20180813175252004.png)

### 建立`models.py`文件

![image-20180813175345726](assets/image-20180813175345726.png)

![image-20180813175542948](assets/image-20180813175542948.png)

### 将`main.py`中的模型类，剪切到`models.py`中

![image-20180813175801726](assets/image-20180813175801726.png)

### 剪切后的效果

![image-20180813180049466](assets/image-20180813180049466.png)

### 重启flask项目，浏览器重新访问

![image-20180813180139533](assets/image-20180813180139533.png)

## 4. 总结

![image-20180813180539732](assets/image-20180813180539732.png)