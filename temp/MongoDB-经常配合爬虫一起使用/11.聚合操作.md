# 聚合操作



## 一、MongoDB的聚合是什么

聚合(aggregate)是基于数据处理的聚合管道，每个文档通过一个由多个阶段（stage）组成的管道，可以对每个阶段的管道进行分组、过滤等功能，然后经过一系列的处理，输出相应的结果。

语法：

```
db.集合名称.aggregate({管道:{表达式}})
```



![img](assets/mongodb的聚合.png)



## 二、常用管道

 在MongoDB中，⽂档处理完毕后， 通过管道进⾏下⼀次处理  常用管道命令如下：

- `$match`： 过滤数据， 只输出符合条件的⽂档
- `$group`： 将集合中的⽂档分组， 可⽤于统计结果
- `$project`： 修改输⼊⽂档的结构， 如重命名、 增加、 删除字段、 创建计算结果
- `$sort`： 将输⼊⽂档排序后输出
- `$limit`： 限制聚合管道返回的⽂档数
- `$skip`： 跳过指定数量的⽂档， 并返回余下的⽂档



## 三、管道命令之`$match`

`$match`用于进行数据的过滤，是在能够在聚合操作中使用的命令，和`find`区别在于`$match` 操作可以把结果交给下一个管道处理，而`find`不行

使用示例如下：

1. 查询年龄为18岁的学生

   ```
   db.stu.aggregate({$match:{age:18}})
   ```

2. 查询年龄大于20的学生

   ```json
   db.stu.aggregate({"$match": {age:{"$gt": 18}}})
   ```
   
3. 查询年龄为18~40之间的学生

   ```
   db.stu.aggregate({$match:{age:{$gte:18, $lte:40}}})
   ```
   
4. 查询年龄为18~40之间gender为true的学生
  
   ```
   db.stu.aggregate({$match:{age:{$gte:18, $lte:40}, gender:true}})
   ```
   
5. 查询年龄大于20的男女学生的人数

   ```json
    db.stu.aggregate([
        {$match:{age:{$gt:20}}},
        {$group:{_id:"$gender",counter:{$sum:1}}}
   ])
   ```





## 四、管道命令之`$group`

### 1. 按照某个字段进行分组

`$group`是所有聚合命令中用的最多的一个命令，用来将集合中的文档分组，可用于统计结果

使用格式如下：

```
{
  $group:
    {
      _id: <expression>, // Group By Expression
      <field1>: { <accumulator1> : <expression1> },
      ...
    }
 }
```

说明：

* `_id`为必选字段，为被分组字段，可为空或`null`

* `accumulator`为可选字段，其中可包含一下运算符：

  ![image-20201109160228611](assets/image-20201109160228611.png)

具体可以参考官方文档：https://docs.mongodb.com/manual/reference/operator/aggregation/group/#pipe._S_group



### 2. 常用表达式

表达式：处理输⼊⽂档并输出

语法：`表达式:'$列名'`  常⽤表达式:

- `$sum`： 计算总和，` $sum:1` 表示以1倍计数
- `$avg`： 计算平均值
- `$min`： 获取最⼩值
- `$max`： 获取最⼤值
- `$push`： 在结果⽂档中插⼊值到⼀个数组中



使用示例如下

```json
db.stu.aggregate(
    {$group:
        {
            _id:"$gender",
            counter:{$sum:1}
        }
    }
)
```

其中注意点：

- `db.db_name.aggregate`是语法，所有的管道命令都需要写在其中
- `_id` 表示分组的依据，按照哪个字段进行分组，需要使用`$gender`表示选择这个字段进行分组
- `$sum:1` 表示把每条数据作为1进行统计，统计的是该分组下面数据的条数



### 3. 练习

1.按照性别进行分组

```
db.stu.aggregate({$group:{_id:"$gender"}})
```

![image-20201109164611243](assets/image-20201109164611243.png)

2.按照性别分组，显示每组的数量

```
db.stu.aggregate({$group:{_id:"$gender", "数量": {$sum: 1}}})
```

![image-20201109164633970](assets/image-20201109164633970.png)

3.按照性别分组，显示每组的数量、姓名

```
db.stu.aggregate({$group:{_id:"$gender", "数量": {$sum: 1}, "姓名": {$push: "$name"}}})
```

![image-20201109164745335](assets/image-20201109164745335.png)

4.按照性别分组，显示每组的数量、姓名、平均年龄

```
db.stu.aggregate({$group:{_id:"$gender", "数量": {$sum: 1}, "姓名": {$push: "$name"}, "平均年龄":{$avg:"$age"}}})
```

![image-20201109164835247](assets/image-20201109164835247.png)



### 4. group by null

当我们需要统计整个文档的时候，`$group` 的另一种用途就是把整个文档分为一组进行统计

demo1:

```json
db.stu.aggregate(
    {$group:
        {
            _id:null,
            counter:{$sum:1}
        }
    }
)
```

运行效果：

![image-20201109164919541](assets/image-20201109164919541.png)

注意：

- `_id:null` 表示不指定分组的字段，即统计整个文档，此时获取的`counter`表示整个文档的个数



demo2:统计所有平均年龄

```
db.stu.aggregate(
    {$group:
        {
            _id:null,
            "平均年龄":{$avg:"$age"}
        }
    }
)
```

![image-20201109165100879](assets/image-20201109165100879.png)



### 5. 数据透视

正常情况在统计的不同性别的时候，需要知道所有的name，需要逐条观察，如果通过某种方式把所有的name放到一起，那么此时就可以理解为数据透视

使用示例如下：

1. 统计不同性别的学生

   ```json
    db.stu.aggregate(
        {$group:
            {
                _id:null,
                name:{$push:"$name"}
            }
        }
    )
   ```

   ![image-20201109165245470](assets/image-20201109165245470.png)

2. 使用`$$ROOT`可以将整个文档放入数组中

   ```json
    db.stu.aggregate(
        {$group:
            {
                _id:null,
                name:{$push:"$$ROOT"}
            }
        }
    )
   ```

   ![image-20201109165231315](assets/image-20201109165231315.png)



### 6. 多次聚合

对于如下数据，需要统计出每个country/province下的userid的数量（同一个userid只统计一次）

```json
{ "country" : "china", "province" : "sh", "userid" : "a" }  
{  "country" : "china", "province" : "sh", "userid" : "b" }  
{  "country" : "china", "province" : "sh", "userid" : "a" }  
{  "country" : "china", "province" : "sh", "userid" : "c" }  
{  "country" : "china", "province" : "bj", "userid" : "da" }  
{  "country" : "china", "province" : "bj", "userid" : "fa" }
```

参考答案

1.插入上述测试数据

```
db.stu2.insert([{ "country" : "china", "province" : "sh", "userid" : "a" },
{  "country" : "china", "province" : "sh", "userid" : "b" },
{  "country" : "china", "province" : "sh", "userid" : "a" }, 
{  "country" : "china", "province" : "sh", "userid" : "c" }, 
{  "country" : "china", "province" : "bj", "userid" : "da" },  
{  "country" : "china", "province" : "bj", "userid" : "fa" }])
```

2.统计

```
db.stu2.aggregate(
{$group:{_id:{country:"$country", province:"$province", userid:"$userid"}}},
{$group:{_id:null, counter:{$sum:1}}}
)
```

说明：

![image-20201109170525361](assets/image-20201109170525361.png)



## 五、管道命令之`$project`

### 1. 使用

`$project`用于修改文档的输入输出结构，例如重命名，增加，删除字段

使用示例如下：

1. 查询学生的年龄、姓名，仅输出年龄姓名

   ```json
   db.stu.aggregate(
   	{$project:{_id:0,name:1,age:1}}
   )
   ```

   ![image-20201109170736449](assets/image-20201109170736449.png)

2. 查询男女生的人数

   ```json
   db.stu.aggregate(
   	{$group:{_id:"$gender",counter:{$sum:1}}},
   	{$project:{_id:0,counter:1}}
   )
   ```

   ![image-20201109170847227](assets/image-20201109170847227.png)



### 2. 练习

对于如下数据：统计出每个country/province下的userid的数量（同一个userid只统计一次），结果中的字段为{国家:""，省份:""，数量:""}

```json
{ "country" : "china", "province" : "sh", "userid" : "a" }  
{  "country" : "china", "province" : "sh", "userid" : "b" }  
{  "country" : "china", "province" : "sh", "userid" : "a" }  
{  "country" : "china", "province" : "sh", "userid" : "c" }  
{  "country" : "china", "province" : "bj", "userid" : "da" }  
{  "country" : "china", "province" : "bj", "userid" : "fa" }
```

参考答案:

前面在练习`$group`时已经在stu2集合中插入了数据，此时我们就不再插入数据了，直接查询统计

```
db.stu2.aggregate(
  {$group:{_id:{"国家":'$country', "省份":'$province',userid:'$userid'}}},
  {$group:{_id:{"国家":'$_id.国家', "省份":'$_id.省份'},counter:{$sum:1}}},
  {$project:{_id:0, "国家":'$_id.国家', "省份":'$_id.省份', "数量":'$counter'}}
)
```

![image-20201109171349381](assets/image-20201109171349381.png)



## 六、管道命令之`$sort`

`$sort`用于将输入的文档排序后输出

使用示例如下：

1. 查询学生信息，按照年龄升序

   ```json
    db.stu.aggregate({$sort:{age:1}})
   ```

2. 查询男女人数，按照人数降序

   ```json
    db.stu.aggregate(
        {$group:{_id:"$gender", counter:{$sum:1}}},
        {$sort:{counter:-1}}
    )
   ```
   
   ![image-20201109171435486](assets/image-20201109171435486.png)



## 七、管道命令之`$skip` 和 `$limit`

- `$limit`限制返回数据的条数
- `$skip` 跳过指定的文档数，并返回剩下的文档数
- 同时使用时先使用skip在使用limit

使用示例如下：

1. 查询2条学生信息

   ```json
    db.stu.aggregate(
        {$limit:2}
    )
   ```

2. 查询从第3条开始的学生信息

   ```json
    db.stu.aggregate(
        {$skip:2}
    )
   ```

3. 统计男女生人数，按照人数升序，返回第二条数据

   ```json
    db.stu.aggregate(
        {$group:{_id:"$gender",counter:{$sum:1}}},
        {$sort:{counter:-1}},
        {$skip:1},
        {$limit:1}
    )
   ```
   
   ![image-20201109171513938](assets/image-20201109171513938.png)