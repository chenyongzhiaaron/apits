# 序列化操作

**本小节学习目标**：
* 掌握单个对象的序列化和多个对象的序列化操作
* 掌握关联对象嵌套序列化的3种方式
* 掌握多关联对象嵌套序列化时many参数的使用

### 1. 序列化单个对象

序列化单个对象obj时，在创建序列化器对象时，将obj传递给instance即可。

```python
from booktest.models import BookInfo
from booktest.serializers import BookInfoSerializer
# 查询获取图书对象
book = BookInfo.objects.get(id=2)
# 创建序列化器对象
serializer = BookInfoSerializer(book)
# 获取序列化之后的数据
serializer.data
# {'id': 2, 'btitle': '天龙八部', 'bpub_date': '1986-07-24', 'bread': 36, 'bcomment': 40}
```

### 2. 序列化多个对象

如果要被序列化的是包含多个对象的查询集QuerySet或list，在创建序列化器对象时，需要添加`many=True`参数。

```python
books = BookInfo.objects.all()
# 创建序列化器对象
serializer = BookInfoSerializer(books, many=True)
# 获取序列化之后的数据
serializer.data
# [
#   OrderedDict([('id', 2), ('btitle', '天龙八部'), ('bpub_date', '1986-07-24'), ('bread', 36), ('bcomment', 40)),
#   OrderedDict([('id', 3), ('btitle', '笑傲江湖'), ('bpub_date', '1995-12-24'), ('bread', 20), ('bcomment', 80)),
#   OrderedDict([('id', 4), ('btitle', '雪山飞狐'), ('bpub_date', '1987-11-11'), ('bread', 58), ('bcomment', 24)),
#   OrderedDict([('id', 5), ('btitle', '西游记'), ('bpub_date', '1988-01-01'), ('bread', 10), ('bcomment', 10)])
# ]
```
> 注：OrderedDict是有序字典类型。

### 3. 关联对象嵌套序列化

如果在序列化对象数据时，需要将其关联的对象一并序列化，则定义序列化器类的字段时，需要在定义对应的关联对象嵌套序列化字段。

例如：在序列化英雄对象数据时，hbook(即和英雄关联的图书)字段如何序列化？

我们先定义HeroInfoSerialzier除关联对象嵌套序列化字段之外的其他部分

```python
class HeroInfoSerializer(serializers.Serializer):
    """英雄数据序列化器"""
    GENDER_CHOICES = (
        (0, 'male'),
        (1, 'female')
    )
    id = serializers.IntegerField(label='ID', read_only=True)
    hname = serializers.CharField(label='名字', max_length=20)
    hgender = serializers.ChoiceField(choices=GENDER_CHOICES, label='性别', required=False)
    hcomment = serializers.CharField(label='描述信息', max_length=200, required=False)
```

对于嵌套关联字段，可以采用以下3种方式进行定义：

1）**PrimaryKeyRelatedField**

**将关联对象序列化为关联对象的主键**。

```python
# 在HeroInfoSerializer中添加此字段
hbook = serializers.PrimaryKeyRelatedField(label='图书', read_only=True)
或
hbook = serializers.PrimaryKeyRelatedField(label='图书', queryset=BookInfo.objects.all())
```

指明字段时需要包含read_only=True或者queryset参数：

* 指定read_only=True参数时，该字段仅在序列化时使用。
* 指定queryset参数时，将被用作反序列化时参数校验使用。

序列化操作：
```python
from booktest.serializers import HeroInfoSerializer
from booktest.models import HeroInfo
hero = HeroInfo.objects.get(id=6)
serializer = HeroInfoSerializer(hero)
serializer.data
```

使用效果：

```python
# {
#     'id': 6,
#     'hname': '乔峰',
#     'hgender': 1,
#     'hcomment': '降龙十八掌',
#     'hbook': 2
# }
```
> 注：使用PrimaryKeyRelatedField将和英雄关联的图书hbook序列化为了hbook的主键。

2）**使用关联对象的序列化器**

使用指定的序列化器类将关联对象进行序列化。

```python
hbook = BookInfoSerializer()
```

使用效果：

```python
# {
#     'id': 6,
#     'hname': '乔峰',
#     'hgender': 1,
#     'hcomment': '降龙十八掌',
#     'hbook': {
#         'id': 2,
#         'btitle': '天龙八部',
#         'bpub_date': '1986-07-24',
#         'bread': 36,
#         'bcomment': 40
#     }
# }
```
> 注：使用BookInfoSerializer将和英雄关联的图书hbook进行序列化。

3) **StringRelatedField**

将关联对象序列化为关联对象模型类\_\_str\_\_方法的返回值。

```python
hbook = serializers.StringRelatedField(label='图书')
```

使用效果：

```python
# {
#     'id': 6,
#     'hname': '乔峰',
#     'hgender': 1,
#     'hcomment': '降龙十八掌',
#     'hbook': '天龙八部'
# }
```
> 注：将和英雄关联的图书hbook序列化为图书模型类\_\_str__方法的返回值。

### 4. many参数

如果和一个对象关联的对象有多个，在序列化器类中定义嵌套序列化字段时，需要多添加一个many=True参数。

如在序列化图书对象时，将和图书关联的英雄一并进行嵌套序列化，需在BookInfoSerializer中添加嵌套序列化字段：

```python
class BookInfoSerializer(serializers.Serializer):
    """图书数据序列化器"""
    id = serializers.IntegerField(label='ID', read_only=True)
    btitle = serializers.CharField(label='名称', max_length=20)
    bpub_date = serializers.DateField(label='发布日期')
    bread = serializers.IntegerField(label='阅读量', required=False)
    bcomment = serializers.IntegerField(label='评论量', required=False)
    # 关联对象嵌套序列化字段
    heroinfo_set = serializers.PrimaryKeyRelatedField(read_only=True, many=True)
```
> 注：此处使用PrimaryKeyRelatedField类型来举例，其他2种方式同样使用。

使用效果：

```python
from booktest.serializers import BookInfoSerializer
from booktest.models import BookInfo
book = BookInfo.objects.get(id=2)
serializer = BookInfoSerializer(book)
serializer.data
# {'
#     id': 2,
#     'btitle': '天龙八部',
#     'bpub_date': '1986-07-24',
#     'bread': 36,
#     'bcomment': 40,
#     'heroinfo_set': [
#         6,
#         8,
#         9
#     ]
# }
```

**总结**：
* 序列化单个对象：创建序列化器对象时，将单个对象传递给instance即可
* 序列化多个对象：创建序列化器对象时，需要添加many=True参数
* 关联对象嵌套序列化
  * 将关联对象序列化为关联对象的主键：PrimaryKeyRelatedField
  * 使用指定的序列化器类将关联对象进行序列化
  * 将关联对象序列化为关联对象模型类\_\_str__方法的返回值：StringRelatedField
  * 如果和被序列化对象关联的对象有多个，定义嵌套序列化字段时，需要添加many=True参数
