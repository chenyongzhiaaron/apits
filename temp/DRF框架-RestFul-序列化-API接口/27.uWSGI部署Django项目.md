# uWSGI简单部署项目

## 1. uWSGI介绍

`uWSGI`是一个Web服务器，它实现了

- WSGI协议
- uwsgi
- http协议

## 2. 概念区分

要注意 `WSGI` / `uwsgi` / `uWSGI` 这三个概念的区分

1. WSGI是一种Web服务器网关接口。它是一个Web服务器（如nginx，uWSGI等服务器）与web应用（如用Flask框架写的程序）通信的一种规范
2. uwsgi是一种线路协议而不是通信协议，在此常用于在uWSGI服务器与其他网络服务器的数据通信
3. 而uWSGI是实现了uwsgi和WSGI两种协议的Web服务器
4. uwsgi协议是一个uWSGI服务器自有的协议，它与WSGI相比是两样东西

![image-20191203140526127](assets/image-20191203140526127.png)

## 3. uWSGI性能很高

![img](assets/720333-20170312154455592-1425120615.png)

## 4. uWSGI特点

注意特点如下：

1. 超快的性能
2. 低内存占用
3. 详尽的日志功能（可以用来分析app性能和瓶颈）
4. 高度可定制（内存大小限制，服务一定次数后重启等）

总而言之uwgi是个部署用的好东东，正如uWSGI作者所吹嘘的：

> If you are searching for a simple wsgi-only server, uWSGI is not for you, but if you are building a real (production-ready) app that need to be rock-solid, fast and easy to distribute/optimize for various load-average, you will pathetically and morbidly fall in love (we hope) with uWSGI.

## 5. uWSGI 安装使用

安装命令如下

```
pip install uwsgi -i http://pypi.douban.com/simple/ --trusted-host pypi.douban.com
```

基本测试

`test.py`:

```python
def application(env, start_response):
    start_response('200 OK', [('Content-Type','text/html')])
    return [b"Hello World"] # python3
    #return ["Hello World"] # python2
```

在`test.py`所在路径下，运行如下命令：

```shell
uwsgi --http :8001 --wsgi-file test.py
```

注意：如果端口占用，使用

```
lsof -i :8001
```

列出占用端口的程序的pid号，并使用以下命令杀掉所有占用端口的程序

```
sudo kill -9 pid
```

然后浏览 `http://127.0.0.1:8001`或http://内网ip:8001、或http://外网ip:8001)查看效果，有”Hello World”输出即安装成功。

![image-20191203112141413](assets/image-20191203112141413.png)

## 6. 美多商城使用uWSGI运行

### 6.1 Django项目的`wsgi.py`

仔细观察发现`meiduo_mall/wsgi.py`中也要一个变量名字叫做`application`，这与上面我们创建的函数名一样，也就是说sWSGI实际上也是去调用了`meiduo_mall/wsgi.py`这个文件，从而让整个项目运行的，但是我们不能直接通过

```
uwsgi --http :8001 --wsgi-file wsgi.py
```

去运行，因为路径、虚拟环境等都没有进行配置，所以，当我们在使用uWSGI服务器启动django项目时，需要建立一个配置文件，在这个文件中写清楚怎样来使用uWSGI来启动这个Django项目即可

### 6.2 创建配置uWSGI的文件

在Django项目中，注意 是在`manage.py`同级目录中，建立`uwsgi.ini`，内容如下：

```ini
[uwsgi]
; 监听的端口
http = :8001

; 项目所在目录，和manage.py同级（-----要修改为自己的路径-----）
chdir = /Users/wangmingdong/Desktop/Code_OnClass/prepare_lesson/meiduo_mall_project_2019_prepare/meiduo_mall

; 虚拟环境所在目录（-----要修改为自己的路径-----）
home = /Users/wangmingdong/workspaces/django1.11.11_py3_class00/
PYTHONHOME = /Users/wangmingdong/workspaces/django1.11.11_py3_class00/bin/

; 主应用中的wsgi文件（-----要修改为自己的路径-----）
wsgi-file = meiduo_mall/wsgi.py

; 启动一个master进程，来管理其余的子进程
master = True
processes = 4
threads = 2

; 代理静态资源：路径映射（-----要修改为自己的路径-----）
static-map = /static=/Users/wangmingdong/Desktop/Code_OnClass/prepare_lesson/meiduo_mall_project_2019_prepare/meiduo_mall/static

; 保存主进程的pid，用来控制uwsgi服务
pidfile = uwsgi.pid

; 启动项目  uwsgi --ini uwsgi.ini
; uwsgi --stop/reload xxx.pid  停止/重启uwsgi

; 设置后台运行，保存日志
daemonize = uwsgi.log
```

显示`[uWSGI] getting INI configuration from uwsgi.ini`表明uwsgi运行成功

![image-20191203115046639](assets/image-20191203115046639.png)

注意：

- 通过 `ps -ef|grep uwsgi` 查看确认是否uwsgi启动

  ![image-20191203115138923](assets/image-20191203115138923.png)

### 6.3 uWSGI常用命令

```
启动：uwsgi --ini uwsgi.ini
停止：uwsgi --stop uwsgi.pid
重启：uwsgi --reload uwsgi.pid
```

## 7. 测试效果

![image-20191203115320904](assets/image-20191203115320904.png)