# 权限Permissions

**本小节目标**：
* 掌握DRF框架的全局权限控制方案设置
* 掌握DRF框架指定视图权限控制方案的设置
* 了解DRF框架自定义权限控制类

### 1. 默认全局权限控制方案

DRF框架提供了四个权限控制类:
* AllowAny   允许所有用户
* IsAuthenticated   仅通过认证的用户
* IsAdminUser   仅管理员用户
* IsAuthenticatedOrReadOnly   认证的用户可以完全操作，否则只能get读取

DRF框架默认在rest_framework.settings文件中进行了全局权限控制方案的设置：
```python
DEFAULTS = {
    'DEFAULT_PERMISSION_CLASSES': (
       'rest_framework.permissions.AllowAny', # 允许所有人
    )
}
```

### 2. 修改全局权限控制方案

可以在DRF项目的`settings.py`文件中修改DRF框架的全局权限控制方案，如：
```python
REST_FRAMEWORK = {
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.IsAuthenticated', # 允许认证用户
    )
}
```
> 注：将全局权限控制方案设置为仅允许认证用户访问。

### 3. 指定视图权限控制方案

可以在具体的视图中通过permission_classes属性来指定某个视图所使用的权限控制类

```python
from rest_framework.permissions import IsAuthenticated
from rest_framework.viewsets import ReadOnlyModelViewSet

from booktest.serializers import BookInfoSerializer
from booktest.models import BookInfo

class BookInfoViewSet(ReadOnlyModelViewSet):
    serializer_class = BookInfoSerializer
    queryset = BookInfo.objects.all()

    # 指定当前视图自己的权限控制方案，不再使用全局权限控制方案
    permission_classes = [IsAuthenticated]
```

### 4. 自定义权限

可以自定义权限控制类，需继承`rest_framework.permissions.BasePermission`父类，并实现以下两个任何一个方法或全部。

- `.has_permission(self, request, view)`

    判断对使用此权限类的视图是否有访问权限， view表示当前视图对象

- `.has_object_permission(self, request, view, obj)`

    判断对使用此权限类视图某个数据对象是否有访问权限， view表示当前视图， obj为数据对象

如：

```python
class MyPermission(BasePermission):
    def has_permission(self, request, view):
        """判断对使用此权限类的视图是否有访问权限"""
        # 任何用户对使用此权限类的视图都没有访问权限
        return True

    def has_object_permission(self, request, view, obj):
        """判断对使用此权限类视图某个数据对象是否有访问权限"""
        # 需求: 对id为1，3的数据对象有访问权限
        if obj.id in (1, 3):
            return True
        return False

class BookInfoViewSet(ReadOnlyModelViewSet):
    # 指定当前视图所使用的查询集
    queryset = BookInfo.objects.all()
    # 指定当前视图所使用的序列化器类
    serializer_class = BookInfoSerializer
    # 使用自定义的权限控制类
    permission_classes = [MyPermission]
```

**总结**：
* DRF框架默认全局权限控制方案：AllowAny(允许所有用户)
* 可以在settings.py配置文件中修改DRF框架默认权限控制方案
* 也可以在指定视图中通过permission_classes设置视图的权限控制方案
* 自定义权限控制类
  * has_permission：判断对使用权限类的视图是否有访问权限
  * has_object_permission：判断对使用权限类视图中某个数据对象是否有访问权限
