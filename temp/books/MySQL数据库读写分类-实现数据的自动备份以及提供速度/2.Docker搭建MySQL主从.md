# Docker搭建MySQL主从

本项目中我们搭建`一主一从`的主从同步，全部采用Docker的方式

## 1. 获取MySQL镜像

主从同步尽量保证多台MySQL的版本相同或相近

```shell
$ docker pull mysql:5.7
```

## 2. 获取MySQL配置文件

![image-20191202103128474](assets/image-20191202103128474.png)

## 3. 修改配置文件

3.1先复制文件夹，得到`mysql.conf.d-master`、`mysql.conf.d-slave`用的配置文件夹

![image-20191202103229621](assets/image-20191202103229621.png)

3.2修改`master`配置

在`mysql.conf.d-master文件夹`下的`mysqld.cnf`中添加如下配置信息：

```
server-id=1
log-bin=/var/log/mysql/mysql-bin.log
```

效果如下：

![image-20191202112913330](assets/image-20191202112913330.png)

3.3修改`slave`配置

在`mysql.conf.d-slave文件夹`下的`mysqld.cnf`中添加如下配置信息：

```
server-id=2
general_log = 0
```

效果如下：

![image-20191202112950528](assets/image-20191202112950528.png)

## 4. 建立2个空文件夹

![image-20191202113222224](assets/image-20191202113222224.png)

## 5. 分别运行2个MySQL容器

### 5.1 运行master容器

```
docker run -it --rm -v /Users/wangmingdong/Desktop/Code_OnClass/prepare_lesson/mysql_master_slave/mysql.conf.d-master/:/etc/mysql/mysql.conf.d -v /Users/wangmingdong/Desktop/Code_OnClass/prepare_lesson/mysql_master_slave/mysql-master-db/:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=python -p 3307:3306 mysql:5.7
```

### 5.2 运行slave容器

```
docker run -it --rm -v /Users/wangmingdong/Desktop/Code_OnClass/prepare_lesson/mysql_master_slave/mysql.conf.d-slave/:/etc/mysql/mysql.conf.d -v /Users/wangmingdong/Desktop/Code_OnClass/prepare_lesson/mysql_master_slave/mysql-slave-db/:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=python -p 3308:3306 mysql:5.7
```

### 5.3 说明

以上2个容器运行时的参数说明：

- `-it`：已交互模型运行，真正部署到服务器上时，可以改为`-d`

- ```
  -v
  ```

  ：使用了2次

  - 第1次将本地的配置文件夹与容器中MySQL需要的配置文件夹进行共享，从而让容器中的MySQL使用我们刚刚配置的信息
  - 第2次将本地的文件夹与容器的`/var/lib/mysql`进行共享，目的是让容器在运行中产生的数据存储在宿主机，保证数据不会因为容器的结束而被删除

- `-p`：master用的端口是`3307`，slave用的端口是`3308`，以方便后续的配置

### 5.4 测试

测试master能否连接

```
$ mysql -uroot -ppython -h 127.0.0.1 --port=3307
```

测试slave能否连接

```
$ mysql -uroot -ppython -h 127.0.0.1 --port=3308
```

## 6. 主从同步实现

### 6.1 master配置

创建用于从服务器同步数据的帐号

```sql
-- 创建从机账号
GRANT REPLICATION SLAVE ON *.* TO 'slave'@'%' identified by 'slave';
-- 刷新权限
FLUSH PRIVILEGES;
```

展示主机的二进制日志信息

```sql
SHOW MASTER STATUS;
```

![image-20191202114559203](assets/image-20191202114559203.png)

注意：上图中的File字段、Position字段的值，在slave配置中使用

### 6.2 slave配置

配置连接master的信息

```sql
-- 从机连接到主机
change master to master_host='172.17.0.2', master_port=3306, master_user='slave', master_password='slave',master_log_file='mysql-bin.000003', master_log_pos=582;
```

注意：

- `172.17.0.2`的获取是使用的`docker network ls`然后检查`使用 docker network inspect bridge的id`得到的，请注意观察

  ![image-20191202115223707](assets/image-20191202115223707.png)

启动同步

```sql
-- 开启从机服务
start slave;
-- 展示从机服务状态
show slave status \G
```

同步成功效果：

![image-20191202114339450](assets/image-20191202114339450.png)

## 7. 测试

![image-20191202114520566](assets/image-20191202114520566.png)