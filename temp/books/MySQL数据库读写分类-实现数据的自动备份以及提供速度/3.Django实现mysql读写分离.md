# Django实现MySQL读写分离

Django已经实现对MySQL的读写分离，实际上就是将不同的读写请求按一定的规则路由到不同的数据库上（可以是不同类型的数据库），我们需要做的就是，定义不同的数据库，定义不同的路由规则。

## 1. 参考官方文档

https://docs.djangoproject.com/en/dev/topics/db/multi-db/

可以点击上述的网址，查看django官网信息

![image-20191202211020592](assets/image-20191202211020592.png)

## 2. 实现美多商城读写分离

### 2.1 准备

将之前的`meiduo_mall_2019_prepare`数据库备份，然后在新的主从MySQL中的 主中创建数据库且导入刚刚得到的数据，效果如下：

![image-20191202205744298](assets/image-20191202205744298.png)

### 2.2 增加slave数据库的配置

```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',  # 数据库引擎
        'HOST': '127.0.0.1',  # 数据库主机
        'PORT': 3307,  # 数据库端口
        'USER': 'root',  # 数据库用户名
        'PASSWORD': 'python',  # 数据库用户密码
        'NAME': 'meiduo_mall_2019_prepare'  # 数据库名字
    },
    'slave': {  # 读（从机）
        'ENGINE': 'django.db.backends.mysql',
        'HOST': '127.0.0.1',
        'PORT': 3308,
        'USER': 'root',
        'PASSWORD': 'python',
        'NAME': 'meiduo_mall_2019_prepare'
    }
}
```

### 2.3 创建和配置数据库读写路由

创建数据库读写路由

在`utils.db_router.py`中实现读写路由

```python
import random


class MasterSlaveDBRouter(object):
    """数据库读写路由"""

    def db_for_read(self, model, **hints):
        """读"""
        ret = random.choice(["default", "slave"])
        print(ret)
        return ret  # 随机选择一个数据库进行读取操作

    def db_for_write(self, model, **hints):
        """写"""
        return "default"

    def allow_relation(self, obj1, obj2, **hints):
        """是否运行关联操作"""
        return True
```

效果： ![image-20191202210759761](assets/image-20191202210759761.png)

### 2.4 配置数据库读写路由

```python
DATABASE_ROUTERS = ['utils.db_router.MasterSlaveDBRouter']
```

![image-20191202210739511](assets/image-20191202210739511.png)

## 3. 运行&测试

运行美多商城，然后使用浏览器访问测试，会发现修改的信息立刻会同步到slave数据库中，而且读取时能够看到在master、slave中任选则进行读取，从一定程度上提高了mysql的读取效率

![image-20191202210915599](assets/image-20191202210915599.png)![image-20191202210905489](assets/image-20191202210905489.png)