# flask使用数据库-基础

## 1. 引入

![image-20180813160817809](assets/image-20180813160817809.png)

#### 问题

> 难道在profile_v4函数中，接收了user_id标记的用户数据，直接传递给render_template函数之后就完事了？？？？？
>
> 如果没有这用户，怎么办？
>
> 要是还需要这个用户的其他信息，例如手机号，家庭地址，怎么办？
>
> 难道一定要让用户用浏览器访问时写在url中？？？

#### 解决

> 只需要知道用户的标记，例如qq993484988即可，然后拿着这个用户的标记信息，到数据库中查询出于这个用户所需要的信息，例如：家庭地址，，，再然后将这些数据传递到render_template函数中让它替换到合适的html数据中，这样就完美解决了



## 2. 数据库准备

### 2.1. 新建一个数据库

```sql
create database flask_1 charset=utf8;
```

![image-20180813161930246](assets/image-20180813161930246.png)

### 2.2. 新建立一个数据表

```sql
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` varchar(50) NOT NULL,
  `user_name` varchar(50) NOT NULL,
  `head_img` varchar(200) DEFAULT NULL,
  `short_description` varchar(300) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8
```

![image-20180813163433035](assets/image-20180813163433035.png)

### 2.3. 导入数据

```sql
insert into `flask_1`.`user` (
  `head_img`, `user_id`, `short_description`, `user_name`
) 
values (
'993484988.jpeg', '993484988', '我就是老王，你不懂我，但我熟掌你心，哈哈哈哈哈', '老王'
);

```

### 2.4. 查询所有数据

![image-20180813163517500](assets/image-20180813163517500.png)

## 3. 在视图函数中添加对数据库的操作

### 版本1:

```python
from flask import Flask
from flask import render_template
import pymysql

# 创建flask对象
app = Flask(__name__)

@app.route("/")
def index():
    """
    这个函数用来完成一个url对应的逻辑处理
    :return:
    """
    return "哈哈哈 ，我是第一个flask页面，成功的道理开始了..."

@app.route("/test")
def test():
    return "这是test页面"

@app.route("/profile")
def profile():
    """
    返回html页面数据
    :return:
    """
    # return "<h1>我是个人主页</h1>"
    with open("profile.html") as f:
        content = f.read()
    return content

@app.route("/profile_v2/<user_id>")  # <user_id>表示匹配url时，这里的数据提取出来
def profile_v2(user_id):  # 将提取出来的数据传递给<user_id>中<>内的名字，而且函数的形参也是这个名字
    return "<h1>这是%s的个人主页</h1>" % user_id

@app.route("/profile_v3/<user_id>")
def profile_v3(user_id):
    # return "<h1>这是%s的个人主页</h1>" % user_id
    # 1. 读取profile.html文件
    with open("profile.html") as f:
        content = f.read()

    # 2. 将刚刚标记的那个特殊字符串，进行替换；即将xxxx替换为user_id
    content = content.replace("xxxx", user_id)

    # 3. 将替换之后的HTML页面数据返回，浏览器就可以看到自己个人简历了
    return content

@app.route("/profile_v4/<user_id>")
def profile_v4(user_id):
    # return render_template("profile.html")
    return render_template("profile.html", xxxx=user_id)

@app.route("/profile_v5/<user_id>")
def profile_v5(user_id):
    # ================= 这里添加新代码 ====================
    # 1. 查询数据库
    # 1.1 创建Connection连接
    conn = pymysql.connect(host='localhost', port=3306, database='flask_1', user='root', password='123456', charset='utf8')
    # 1.2 获得Cursor对象
    cs1 = conn.cursor()
    # 1.3 构造参数列表
    params = [user_id]
    # 1.4 执行select语句，并返回受影响的行数：查询所有数据
    cs1.execute('select * from user where user_id=%s', params)
    # 1.5 获取查询的结果
    result = cs1.fetchone()
    # result = cs1.fetchall()
    print(result)
    # 1.6 关闭Cursor对象
    cs1.close()
    # 1.7 闭Connection对象
    conn.close()

    # 2. 模板渲染
    return render_template("profile.html", xxxx=user_id)

if __name__ == '__main__':
    app.run()

```

### 重启flask工程, 浏览器重新访问

![image-20180813165045567](assets/image-20180813165045567.png)

![image-20180813164933500](assets/image-20180813164933500.png)

### 版本2：

> 修改profile.html模板文件

![image-20180813165407929](assets/image-20180813165407929.png)

![image-20180813165522315](assets/image-20180813165522315.png)

## 4. 作业

![image-20180813165705590](assets/image-20180813165705590.png)

### 步骤1

![image-20180813165859344](assets/image-20180813165859344.png)

### 步骤2

![image-20180813170026346](assets/image-20180813170026346.png)

![image-20180813170111382](assets/image-20180813170111382.png)

### 步骤3

> 重启flask工程，重新用浏览器访问

![image-20180813170335048](assets/image-20180813170335048.png)