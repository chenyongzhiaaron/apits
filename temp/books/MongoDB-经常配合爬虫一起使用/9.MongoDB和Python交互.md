# MongoDB和Python交互



## 一、MongoDB和Python交互的模块

`pymongo` 提供了MongoDB和python交互的所有方法

安装方式:
```
pip install pymongo -i https://pypi.tuna.tsinghua.edu.cn/simple
```

![image-20201108203522866](assets/image-20201108203522866.png)



## 二、使用pymongo

### 1. 导入pymongo并选择要操作的集合

数据库和集合如果没有会自动创建

```python
from pymongo import MongoClient
client = MongoClient(host, port)
collection = client[db名][集合名]
```

### 2. 添加数据

`insert`可以批量的插入数据列表，也可以插入一条数据

```python
# 插入一条数据
collection.insert({"name": "test10010", "age": 33})
# 插入多条数据
collection.insert([{"name": "test10010", "age": 33}, {"name": "test10011", "age": 34}])

```

### 3. 添加一条数据

```python
# 插入一条数据
ret = collection.insert_one({"name": "test10010", "age": 33})
print(ret)

```

### 4. 添加多条数据


```python
# 插入多条数据
item_list = [{"name": "test1000%d" % i} for i in range(10)]

# insert_many接收一个列表，列表中为所有需要插入的字典
t = collection.insert_many(item_list)

```

### 5. 查找一条数据


```python
# find_one查找并且返回一个结果,接收一个字典形式的条件
t = collection.find_one({"name": "test10005"})
print(t)
print(type(t))

```

### 6. 查找全部数据

结果是一个Cursor游标对象，是一个可迭代对象，可以类似读文件的指针

```python
# 根据查询条件返回所有满足条件的结果
# t = collection.find({"name": "test10005"})
# find返回所有满足条件的结果，如果条件为空，则返回数据库的所有
t = collection.find()
# 结果是一个Cursor游标对象，是一个可迭代对象，可以类似读文件的指针，
for i in t:
    print(i)
    
print("-" * 30)

for i in t:  # 此时t中没有内容
    print(i)

```

### 7. 更新一条数据

注意使用`$set`命令

```python
# update_one更新一条数据
collection.update_one({"name": "test10005"}, {"$set": {"name": "new_test10005"}})

```

### 8. 更行全部数据

```python
# update_one更新全部数据
collection.update_many({"name": "test10005"}, {"$set": {"name": "new_test10005"}})

```

### 9. 删除一条数据

```python
# delete_one删除一条数据
collection.delete_one({"name": "test10010"})

```

### 10. 删除全部数据

```python
# delete_may删除所有满足条件的数据
collection.delete_many({"name": "test10010"})

```



## 三、练习

1. 使用Python操作MongoDB向集合t3中插入1000个文档
   * 文档的属性包括 `_id`、`name`
   * _id`的值为0、1、2、3、。。。。999`
   * `name`的值为`py0`、`py1`。。。。。
2. 查询显示出`_id`为100的整数倍的文档，如100、200、300…，将`name`输出
3. 将如上代码封装为面向对象方式



参考代码：

```python
from pymongo import MongoClient


class MGINfo(object):
    def __init__(self):
        # 链接MongoDB数据库
        client = MongoClient("127.0.0.1", 27017)
        self.collection = client["test"]["t3"]

    def insert(self):
        # 生成一个包含1000个信息的列表
        info_list = [{"_id": x, "name": "py%s" % x} for x in range(1000)]
        # print(info_list)

        # 插入数据
        ret = self.collection.insert_many(info_list)
        # print(ret)

    def find_100(self):
        # 查询_id为100的整数倍的文档
        ret = self.collection.find({"$where": """
            function() {
                return this._id > 0 && this._id % 100 == 0;
            }
            """})

        print(ret)
        print(ret.count())
        for temp in ret:
            print(temp)


# 创建对象
mongo_info = MGINfo()
# 查询数据
mongo_info.find_100()

```

