# 路由Router

**本小节目标**：
* 掌握路由Router的作用和基本使用
* 理解视图集类属性lookup_value_regex的作用
* 常握视图集中额外处理方法配置项的生成
* 了解SimpleRouter的路由生成规则
* 了解SimpleRouter和DefaultRouter的区别

## 路由Router

**作用**：**动态生成视图集中处理方法的url配置项**。

对于视图集ViewSet，除了可以自己手动进行URL配置指明请求方式与action处理函数之间的对应关系外，还可以使用路由Router来自动生成路由信息。

REST framework提供了两个Router类：

* **SimpleRouter**
* **DefaultRouter**

### 1. 基本使用

1）创建Router对象。

```python
from rest_framework.routers import SimpleRouter, DefaultRouter
router = SimpleRouter() 或 DefaultRouter()
```
2）注册视图集
```python
router.register(prefix, viewset, base_name)
```
> 参数：<br/>
>   prefix：该视图集所有处理函数url地址的统一前缀<br/>
>   viewset：视图集<br/>
>   base_name：该视图集所有处理函数路由name的统一前缀<br/>

3）添加路由数据

```python
urlpatterns = [
    ...
]

# 将生成的路由配置项添加到urlpatterns列表中
urlpatterns += router.urls
```
> 通过router.urls可以获取路由Router生成的url配置项列表。

如：
```python
from booktest import views
# 1. 创建Router对象
from rest_framework.routers import SimpleRouter
router = SimpleRouter()
# 2. 注册视图集
router.register('books', views.BookInfoViewSet, base_name='books')
# 3. 打印生成的url配置项
for url in router.urls:
    print(url)
```

效果如下：
![路由Router生成配置项](../images/路由Router生成配置项.png)

> 注：上面生成了两个配置项，但是提取参数的正则表达式不是\d+，可以在视图集中设置lookup_value_regex指定。

```python
class BookInfoViewSet(ModelViewSet):
    # ...

    # 指定路由Router生成url配置项时，从路径中提取参数的正则表达式
    lookup_value_regex = '\d+'
```

再次执行上面生成url配置项的代码，效果如下：
![路由生成url配置项2](../images/路由生成url配置项2.png)

### 2. 视图集中额外处理方法配置项生成

在视图集中，如果想要让路由Router自动生成视图集中额外添加的处理方法的url配置项，需要给额外的处理方法添加`rest_framework.decorators.action`装饰器。

action装饰器可以接收两个参数：

- **methods**：表明该处理方法对应的请求方式，列表传递。
- **detail**：表明生成url配置项时，是否需要从路径中提取pk数据。
  - True：生成url配置项时，需要从url地址中提取pk参数
  - False：生成url配置项时，不需要从url地址中提取pk参数

如：

```python
from rest_framework import mixins
from rest_framework.viewsets import GenericViewSet
from rest_framework.decorators import action

class BookInfoViewSet(ModelViewSet):
    queryset = BookInfo.objects.all()
    serializer_class = BookInfoSerializer

    # detail为False：生成url配置项时，不需要从地址中提取参数
    @action(methods=['get'], detail=False)
    def latest(self, request):
        """
        返回最新的图书信息
        """
        ...

    # detail为True：生成url配置项时，需要从地址中提取参数
    @action(methods=['put'], detail=True)
    def read(self, request, pk):
        """
        修改图书的阅读量数据
        """
        ...
```

执行上面生成url配置项的代码，效果如下：
![路由Router生成配置项3](../images/路由Router生成配置项3.png)

### 3. 路由router路由生成规则

1） SimpleRouter

![SimpleRouter](/images/simple_router.png)

2）DefaultRouter

![DefaultRouter](/images/default_router.png)

> 注：DefaultRouter与SimpleRouter的区别：<br/>
> 1. DefaultRouter会生成一个根路径/的配置项<br/>
> 2. DefaultRouter生成的每个配置项后都可以跟上`.json`，直接返回json数据。

**总结**：
* 路由Router基本使用
  * 创建Router对象
  * 注册视图集
  * 将动态生成的url配置项列表添加到urlpatterns中
* lookup_value_regex: 设置router生成路由时，从url中提取pk参数对应的正则表达式
* 视图集中额外处理方法的配置项，需要添加action装饰器
* DefaultRouter和SimpleRouter的区别
  * 多生成一个根路径(/)配置项，并且每个配置项地址后都可以跟上`.json`，直接返回json数据。
