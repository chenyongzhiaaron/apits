# 异常处理 Exceptions

**本小节目标**：
* 理解DRF框架的异常处理机制过程
* 掌握DRF框架自定义异常处理函数

## 异常处理

在定义视图接口时，当继承了APIView或其子类之后，视图中如果出现未处理的异常，默认都会调用DRF框架的默认异常处理函数进行处理。

### 1. 默认异常处理

DRF框架的默认异常处理设置如下：

```python
REST_FRAMEWORK = {
    'EXCEPTION_HANDLER': 'rest_framework.views.exception_handler'
}
```

> 注：默认使用`rest_framework.views`模块下的`exception_handler`函数进行异常处理

exception_handler函数可以处理以下异常，处理之后，会给客户端返回对应的响应：

* APIException  所有异常的父类
* ParseError  解析错误
* AuthenticationFailed  认证失败
* NotAuthenticated  尚未认证
* PermissionDenied  权限决绝
* NotFound  未找到
* MethodNotAllowed  请求方式不支持
* NotAcceptable  要获取的数据格式不支持
* Throttled  超过限流次数
* ValidationError  校验失败
* Http404 资源不存在

### 2. 自定义异常处理

可以自定义异常处理函数，在DRF框架默认异常处理函数的基础上，添加一些其他的异常处理，比如数据库处理。

1）自定义异常处理函数

```python
from rest_framework.views import exception_handler as drf_exception_handler
from rest_framework import status
from django.db import DatabaseError

def exception_handler(exc, context):
    # 先调用DRF框架的默认异常处理函数
    response = drf_exception_handler(exc, context)

    if response is None:
        # 补充数据库的异常处理
        if isinstance(exc, DatabaseError):
            response = Response({'detail': '数据库错误'}, status=status.HTTP_507_INSUFFICIENT_STORAGE)

    return response
```

2）在settings.py配置文件中修改DRF框架的异常处理函数

```python
REST_FRAMEWORK = {
    'EXCEPTION_HANDLER': 'booktest.utils.exceptions.exception_handler'
}
```

**总结**：
* DRF框架默认异常处理函数：
  * `rest_framework.views.exception_handler`
  * 若能处理异常返回response，不能处理返回None
* DRF框架自定义异常处理函数：
  * 自定义异常处理函数，添加其他异常处理
  * 修改`EXCEPTION_HANDLER`配置项
