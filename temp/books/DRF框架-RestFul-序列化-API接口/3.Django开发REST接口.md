# 使用Django开发REST API

**本小节学习目标**：
* 理解API接口的设计过程
* 掌握图书管理5个API接口的实现

### 1. 准备工作

1）模型类定义

创建应用`booktest`并新建模型类BookInfo和HeroInfo。
```python
# models.py
class BookInfo(models.Model):
    """图书模型类"""
    btitle = models.CharField(max_length=20, verbose_name='标题')
    bpub_date = models.DateField(verbose_name='发布日期')
    bread = models.IntegerField(default=0, verbose_name='阅读量')
    bcomment = models.IntegerField(default=0, verbose_name='评论量')
    is_delete = models.BooleanField(default=False, verbose_name='删除标记')

    class Meta:
        db_table = 'tb_books'
        verbose_name = '图书'
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.btitle


class HeroInfo(models.Model):
    """英雄模型类"""
    GENDER_CHOICES = (
        (0, '男'),
        (1, '女')
    )
    hname = models.CharField(max_length=20, verbose_name='名称')
    hgender = models.SmallIntegerField(choices=GENDER_CHOICES, default=0, verbose_name='性别')
    hcomment = models.CharField(max_length=200, null=True, verbose_name='备注')
    is_delete = models.BooleanField(default=False, verbose_name='删除标记')
    hbook = models.ForeignKey('BookInfo', on_delete=models.CASCADE, verbose_name='所属图书')

    class Meta:
        db_table = 'tb_heros'
        verbose_name = '英雄'
        verbose_name_plural = verbose_name

    def __str__(self):
        return self.hname
```

2）创建数据表
```
python manage.py makemigrations
python manage.py migrate
```

3）添加测试数据
```sql
insert into tb_books(btitle,bpub_date,bread,bcomment,is_delete) values
('射雕英雄传','1980-5-1',12,34,0),
('天龙八部','1986-7-24',36,40,0),
('笑傲江湖','1995-12-24',20,80,0),
('雪山飞狐','1987-11-11',58,24,0);

insert into tb_heros(hname,hgender,hbook_id,hcomment,is_delete) values
('郭靖',1,1,'降龙十八掌',0),
('黄蓉',0,1,'打狗棍法',0),
('黄药师',1,1,'弹指神通',0),
('欧阳锋',1,1,'蛤蟆功',0),
('梅超风',0,1,'九阴白骨爪',0),
('乔峰',1,2,'降龙十八掌',0),
('段誉',1,2,'六脉神剑',0),
('虚竹',1,2,'天山六阳掌',0),
('王语嫣',0,2,'神仙姐姐',0),
('令狐冲',1,3,'独孤九剑',0),
('任盈盈',0,3,'弹琴',0),
('岳不群',1,3,'华山剑法',0),
('东方不败',0,3,'葵花宝典',0),
('胡斐',1,4,'胡家刀法',0),
('苗若兰',0,4,'黄衣',0),
('程灵素',0,4,'医术',0),
('袁紫衣',0,4,'六合拳',0);
```

### 2. 需求说明

定义一套符合Restful风格的API接口，实现对图书的以下操作：
```
1. 获取所有的图书数据
2. 新增一本图书数据
3. 获取指定的图书数据
4. 修改指定的图书数据
5. 删除指定的图书数据
```

### 3. 接口设计

**API接口设计思路**：
1. 确定请求方式和URL地址
2. 确定请求参数和格式
  * 通过url地址传递参数，如：`/books/(?P<pk>\d+)/`
  * 通过查询字符串传参参数，如：`/books/?page=<页码>&pagesize=<页容量>`
  * 通过请求体传递参数，如：`post表单数据和json数据`
  * 通过请求头传递参数
3. 确定响应数据和格式以及响应状态码

**图书管理接口设计**：
```python
1. 获取所有的图书数据
API: GET /books/
参数：无
响应：
  状态码：200
  [
      {
          "id": "图书id",
          "btitle": "图书名称",
          "bpub_date": "出版日期",
          "bread": "阅读量",
          "bcomment": "评论量"
      },
      ...
  ]

2. 新增一本图书数据
API: POST /books/
参数：
  {
      "btitle": "图书名称",
      "bpub_date": "出版日期"
  }
响应：
  状态码：201
  {
      "id": "图书id",
      "btitle": "图书名称",
      "bpub_date": "出版日期",
      "bread": "阅读量",
      "bcomment": "评论量"
  }

3. 获取指定的图书数据
API: GET /books/<图书ID>/
参数：
  通过URL地址传递图书ID
响应：
  状态码：200
  {
      "id": "图书id",
      "btitle": "图书名称",
      "bpub_date": "出版日期",
      "bread": "阅读量",
      "bcomment": "评论量"
  }

4. 修改指定的图书数据
API: PUT /books/<图书ID>/
参数：
  通过URL地址传递图书ID
  {
      "btitle": "图书名称",
      "bpub_date": "出版日期"
  }
响应：
  状态码：200
  {
      "id": "图书id",
      "btitle": "图书名称",
      "bpub_date": "出版日期",
      "bread": "阅读量",
      "bcomment": "评论量"
  }

5. 删除指定的图书数据
API: DELETE /books/<图书ID>/
参数：
  通过URL地址传递图书ID
响应：
  状态码：204
```

### 4. 代码实现

1）在`booktest/views.py`文件中定义视图实现API接口。

```python
# views.py
# /books/
class BookListView(View):
    """
    获取所有图书、增加图书
    """
    def get(self, request):
        """
        获取所有的图书数据
        """
        queryset = BookInfo.objects.all()
        book_list = []
        for book in queryset:
            book_list.append({
                'id': book.id,
                'btitle': book.btitle,
                'bpub_date': book.bpub_date,
                'bread': book.bread,
                'bcomment': book.bcomment
            })
        return JsonResponse(book_list, safe=False)

    def post(self, request):
        """
        新增一个图书数据
        """
        json_bytes = request.body
        json_str = json_bytes.decode()
        book_dict = json.loads(json_str)

        # TODO: 此处详细的校验参数省略

        book = BookInfo.objects.create(
            btitle=book_dict.get('btitle'),
            bpub_date=book_dict.get('bpub_date')
        )

        return JsonResponse({
            'id': book.id,
            'btitle': book.btitle,
            'bpub_date': book.bpub_date,
            'bread': book.bread,
            'bcomment': book.bcomment
        }, status=201)

# /books/(?P<pk>\d+)/
class BookDetailView(View):
    """
    获取、修改、删除指定图书
    """
    def get(self, request, pk):
        """
        获取指定图书
        """
        try:
            book = BookInfo.objects.get(pk=pk)
        except BookInfo.DoesNotExist:
            return HttpResponse(status=404)

        return JsonResponse({
            'id': book.id,
            'btitle': book.btitle,
            'bpub_date': book.bpub_date,
            'bread': book.bread,
            'bcomment': book.bcomment
        })

    def put(self, request, pk):
        """
        修改指定图书
        """
        try:
            book = BookInfo.objects.get(pk=pk)
        except BookInfo.DoesNotExist:
            return HttpResponse(status=404)

        json_bytes = request.body
        json_str = json_bytes.decode()
        book_dict = json.loads(json_str)

        # TODO: 此处详细的校验参数省略

        book.btitle = book_dict.get('btitle')
        book.bpub_date = book_dict.get('bpub_date')
        book.save()

        return JsonResponse({
            'id': book.id,
            'btitle': book.btitle,
            'bpub_date': book.bpub_date,
            'bread': book.bread,
            'bcomment': book.bcomment
        })

    def delete(self, request, pk):
        """
        删除指定图书：
        """
        try:
            book = BookInfo.objects.get(pk=pk)
        except BookInfo.DoesNotExist:
            return HttpResponse(status=404)

        book.delete()

        return HttpResponse(status=204)
```

2）在`booktest`子应用下新建`urls.py`文件，并进行URL配置。

```python
# urls.py
urlpatterns = [
    url(r'^books/$', views.BookListView.as_view()),
    url(r'^books/(?P<pk>\d+)/$', views.BookDetailView.as_view())
]
```

### 5. 接口测试

使用Postman测试以上接口：

1）获取所有图书数据

GET 方式访问`http://127.0.0.1:8000/books/`， 返回状态码200，数据如下：

```json
[
    {
        "id": 1,
        "btitle": "射雕英雄传",
        "bpub_date": "1980-05-01",
        "bread": 12,
        "bcomment": 34
    },
    {
        "id": 2,
        "btitle": "天龙八部",
        "bpub_date": "1986-07-24",
        "bread": 36,
        "bcomment": 40
    },
    {
        "id": 3,
        "btitle": "笑傲江湖",
        "bpub_date": "1995-12-24",
        "bread": 20,
        "bcomment": 80
    },
    {
        "id": 4,
        "btitle": "雪山飞狐",
        "bpub_date": "1987-11-11",
        "bread": 58,
        "bcomment": 24
    },
    {
        "id": 5,
        "btitle": "西游记",
        "bpub_date": "1988-01-01",
        "bread": 10,
        "bcomment": 10
    },
    {
        "id": 6,
        "btitle": "水浒传",
        "bpub_date": "1992-01-01",
        "bread": 10,
        "bcomment": 11
    },
    {
        "id": 7,
        "btitle": "红楼梦",
        "bpub_date": "1990-01-01",
        "bread": 0,
        "bcomment": 0
    }
]
```

2）获取指定图书数据

GET方式访问`http://127.0.0.1:8000/books/5/`，返回状态码200， 数据如下：

```json
{
    "id": 5,
    "btitle": "西游记",
    "bpub_date": "1988-01-01",
    "bread": 10,
    "bcomment": 10
}
```

GET方式访问`http://127.0.0.1:8000/books/100/`，返回状态码404。

3）新增一个图书数据

POST方式访问`http://127.0.0.1:8000/books/`，发送JSON数据：

```json
{
	"btitle": "三国演义",
	"bpub_date": "1990-02-03"
}
```

返回状态码201，数据如下：

```json
{
    "id": 8,
    "btitle": "三国演义",
    "bpub_date": "1990-02-03",
    "bread": 0,
    "bcomment": 0
}
```

4）修改指定图书数据

PUT方式访问`http://127.0.0.1:8000/books/8/`，发送JSON数据：

```json
{
	"btitle": "三国演义（第二版）",
	"bpub_date": "1990-02-03"
}
```

返回状态码200，数据如下：

```json
{
    "id": 8,
    "btitle": "三国演义（第二版）",
    "bpub_date": "1990-02-03",
    "bread": 0,
    "bcomment": 0
}
```

5）删除指定图书数据

DELETE方式访问 `http://127.0.0.1:8000/books/8/`，返回204状态码。

**总结**：
* API接口设计过程：
  * 请求方式和请求url地址
  * 请求参数的传递
  * 响应数据及响应状态码
