# 序列化器类定义

**本小节学习目标**：
* 知道序列化器的功能
* 掌握序列化器类的基本定义形式
* 熟悉序列化器序列化功能和反序列化功能的基本使用
* 理解序列化器类定义时常见的选项参数

### 1. 序列化器功能

* 序列化：将实例对象转换为字典
* 反序列化
  * 数据校验
  * 数据保存-新增和更新

### 2. 序列化器类定义

基本形式：
```python
# 模型类定义
from django.db import models

class 模型类名(models.Model):
  # 模型类字段 = models.字段类型(选项参数)
  # ...

# 序列化器类定义
from rest_framework import serializers

class 序列化器类名(serializers.Serializer):
    # 序列化器字段 = serializers.字段类型(选项参数)
    # ...
```

例如：
```python
# tests.py
class User(object):
    """用户类"""
    def __init__(self, name, age):
        self.name = name
        self.age = age

class UserSerializer(serializers.Serializer):
    """用户序列化器类"""
    name = serializers.CharField()
    age = serializers.IntegerField()

```

> 注：UserSerializer可以针对User进行数据的序列化和反序列化操作。

> 注：运行一个单独的py文件，而该py文件中需要使用Django中的东西，则需要在py文件的开头添加以下代码：

```python
# 设置Django运行所依赖的环境变量
import os
if not os.environ.get('DJANGO_SETTINGS_MODULE'):
  os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'drf_demo.settings')

# 让Django进行一次初始化
import django
django.setup()
```

### 3. 序列化器基本使用

**使用序列化器时需要先创建一个序列化器类的对象**。

创建：

```python
序列化器类(instance=None, data=empty, **kwarg)
```

说明：

1）用于序列化时，将实例对象传给**instance**参数

2）用于反序列化时，将要被反序列化的数据传给**data**参数

### 4. 案例演示

1）序列化操作

```python
# 创建User对象
user = User(name='smart', age=18)

# 使用UserSerializer将user对象序列化为如下字段数据：{'name': 'smart', 'age': 18}
serializer = UserSerializer(user)

# 获取序列化之后的数据
serializer.data
```

2）反序列化操作-数据校验

```python
# 准备数据
data = {'name': 'admin', 'age': 30}

# 使用UserSerializer对data中的数据进行反序列化校验
serializer = UserSerializer(data=data)

# 调用is_valid进行数据校验，成功返回True，失败返回False
serializer.is_valid()

# 获取校验失败之后的错误提示信息
serializer.errors

# 获取校验通过之后的数据
serializer.validated_data
```

### 5. 字段类型和选项参数

**常用字段类型**：

| 字段                    | 字段构造方式                                                 |
| ----------------------- | ------------------------------------------------------------ |
| **BooleanField**        | BooleanField()                                               |
| **NullBooleanField**    | NullBooleanField()                                           |
| **CharField**           | CharField(max_length=None, min_length=None, allow_blank=False, trim_whitespace=True) |
| **EmailField**          | EmailField(max_length=None, min_length=None, allow_blank=False) |
| **RegexField**          | RegexField(regex, max_length=None, min_length=None, allow_blank=False) |
| **SlugField**           | SlugField(max\_length=50, min_length=None, allow_blank=False) <br/> 正则字段，验证正则模式 [-a-zA-Z0-9_-]+ |
| **URLField**            | URLField(max_length=200, min_length=None, allow_blank=False) |
| **UUIDField**           | UUIDField(format='hex_verbose')    <br/>  format: <br/>1)   `'hex_verbose'` 如`"5ce0e9a5-5ffa-654b-cee0-1238041fb31a"` <br/>2） `'hex'`  如 `"5ce0e9a55ffa654bcee01238041fb31a"` <br/>3）`'int'` - 如: `"123456789012312313134124512351145145114"`  <br/>4）`'urn'` 如: `"urn:uuid:5ce0e9a5-5ffa-654b-cee0-1238041fb31a"` |
| **IPAddressField**      | IPAddressField(protocol='both', unpack_ipv4=False, **options) |
| **IntegerField**        | IntegerField(max_value=None, min_value=None)                 |
| **FloatField**          | FloatField(max_value=None, min_value=None)                   |
| **DecimalField**        | DecimalField(max_digits, decimal_places, coerce_to_string=None, max_value=None, min_value=None)<br/>max_digits:  最多位数<br/>decimal_palces:  小数点位置 |
| **DateTimeField**       | DateTimeField(format=api_settings.DATETIME_FORMAT, input_formats=None) |
| **DateField**           | DateField(format=api_settings.DATE_FORMAT, input_formats=None) |
| **TimeField**           | TimeField(format=api_settings.TIME_FORMAT, input_formats=None) |
| **DurationField**       | DurationField()                                              |
| **ChoiceField**         | ChoiceField(choices)<br/>choices与Django的用法相同           |
| **MultipleChoiceField** | MultipleChoiceField(choices)                                 |
| **FileField**           | FileField(max_length=None, allow_empty_file=False, use_url=UPLOADED_FILES_USE_URL) |
| **ImageField**          | ImageField(max_length=None, allow_empty_file=False, use_url=UPLOADED_FILES_USE_URL) |
| **ListField**           | ListField(child=<A_FIELD_INSTANCE>, min_length=None, max_length=None) |
| **DictField**           | DictField(child=<A_FIELD_INSTANCE>)                          |


**通用参数**：无论哪种字段类型都可以使用的选项参数。

| 参数名称           | 说明                                      |
| ------------------ | ----------------------------------------|
| **read_only**      | 表明该字段仅用于序列化输出，默认False         |
| **write_only**     | 表明该字段仅用于反序列化输入，默认False       |
| **required**       | 表明该字段在反序列化时必须输入，默认True      |
| **default**        | 序列化和反序列化时使用的默认值               |
| **error_messages** | 包含错误编号与错误信息的字典                 |
| **label**          | 用于HTML展示API页面时，显示的字段名称        |

> 注：定义序列化器类的字段时，如果没有指定read_only和write_only，则这两个参数默认值都为False，表明对应的字段既在序列化时使用，也在反序列化时使用。

`read_only示例`：
```python
from rest_framework import serializers


class User(object):
    """用户类"""
    def __init__(self, name, age):
        self.name = name
        self.age = age


class UserSerializer(serializers.Serializer):
    """序列化器类"""
    name = serializers.CharField()
    age = serializers.IntegerField(read_only=True)


if __name__ == "__main__":
    # 准备数据
    data = {'name': 'laowang', 'age': 18}

    # 数据校验
    serializer = UserSerializer(data=data)
    res = serializer.is_valid()

    print('校验结果：%s' % res)

    # 如果校验失败，获取校验失败的错误原因
    print(serializer.errors)

    # 如果校验成功，获取校验之后的数据
    print(serializer.validated_data)
```

`示例结果`：
![read_only参数](assets/read_only参数.png)

`write_only示例`：
```python
from rest_framework import serializers


class User(object):
    """用户类"""
    def __init__(self, name, age):
        self.name = name
        self.age = age


class UserSerializer(serializers.Serializer):
    """序列化器类"""
    name = serializers.CharField()
    age = serializers.IntegerField(write_only=True)

if __name__ == "__main__":
    # 创建user对象
    user = User('smart', 18)

    # 将user对象序列化为字典{'name': 'smart', 'age': 18}
    serializer = UserSerializer(user)

    # serializer.data获取序列化之后的字典数据
    print(serializer.data)
```

`示例结果`：
![wirte_only参数](assets/write_only参数.png)

`required示例`：
```python
from rest_framework import serializers


class User(object):
    """用户类"""
    def __init__(self, name, age):
        self.name = name
        self.age = age


class UserSerializer(serializers.Serializer):
    """序列化器类"""
    name = serializers.CharField()
    age = serializers.IntegerField()


if __name__ == "__main__":
    # 准备数据
    data = {'name': 'laowang'}

    # 数据校验
    serializer = UserSerializer(data=data)
    res = serializer.is_valid()

    print('校验结果：%s' % res)

    # 如果校验失败，获取校验失败的错误原因
    print(serializer.errors)

    # 如果校验成功，获取校验之后的数据
    print(serializer.validated_data)
```

`示例结果`：
![required参数](assets/required参数1.png)

`将上面示例中age字段的required设置为False`：
```python
from rest_framework import serializers


class User(object):
    """用户类"""
    def __init__(self, name, age):
        self.name = name
        self.age = age


class UserSerializer(serializers.Serializer):
    """序列化器类"""
    name = serializers.CharField()
    age = serializers.IntegerField(required=False)


if __name__ == "__main__":
    # 准备数据
    data = {'name': 'laowang'}

    # 数据校验
    serializer = UserSerializer(data=data)
    res = serializer.is_valid()

    print('校验结果：%s' % res)

    # 如果校验失败，获取校验失败的错误原因
    print(serializer.errors)

    # 如果校验成功，获取校验之后的数据
    print(serializer.validated_data)
```

`示例结果`：
![required参数](assets/required参数2.png)

`default示例`：<br/>
`序列化时所使用的默认值：`
```python
from rest_framework import serializers


class User(object):
    """用户类"""
    def __init__(self, name, age):
        self.name = name
        self.age = age


class UserSerializer(serializers.Serializer):
    """序列化器类"""
    name = serializers.CharField()
    age = serializers.IntegerField()
    addr = serializers.CharField(default='默认地址')

if __name__ == "__main__":
    # 创建user对象
    user = User('smart', 18)

    # 将user对象序列化为字典{'name': 'smart', 'age': 18}
    serializer = UserSerializer(user)

    # serializer.data获取序列化之后的字典数据
    print(serializer.data)
```

`示例结果`：
![default参数](assets/default参数1.png)

> 注：如果user对象有addr属性，则序列化之后的字典中addr的值不再使用default设置的默认值。

`反序列化时所使用的默认值：`
```python
from rest_framework import serializers


class User(object):
    """用户类"""
    def __init__(self, name, age):
        self.name = name
        self.age = age


class UserSerializer(serializers.Serializer):
    """序列化器类"""
    name = serializers.CharField()
    age = serializers.IntegerField(required=False, default=20)

if __name__ == "__main__":
    # 准备数据
    data = {'name': 'laowang'}

    # 数据校验
    serializer = UserSerializer(data=data)
    res = serializer.is_valid()

    print('校验结果：%s' % res)

    # 如果校验失败，获取校验失败的错误原因
    print(serializer.errors)

    # 如果校验成功，获取校验之后的数据
    print(serializer.validated_data)
```

`示例结果`：
![default参数](assets/default参数2.png)

> 注：如果反序列化时传递的data中包含age，则反序列化之后的字典中age的值不再使用default设置的默认值。

**常用参数**：

| 参数名称            | 作用             |
| ------------------- | ---------------- |
| **max_length**      | 最大长度         |
| **min_length**      | 最小长度         |
| **max_value**       | 最大值           |
| **min_value**       | 最小值           |

> max_length和min_length是针对字符串类型的参数；max_value和min_value是针对数字类型的参数。

### 6. 图书序列化器类定义

```python
class BookInfo(models.Model):
    btitle = models.CharField(max_length=20, verbose_name='名称')
    bpub_date = models.DateField(verbose_name='发布日期', null=True)
    bread = models.IntegerField(default=0, verbose_name='阅读量')
    bcomment = models.IntegerField(default=0, verbose_name='评论量')
    is_delete = models.BooleanField(default=False, verbose_name='删除标记')
```

定义一个和BookInfo对应的序列化器类:

```python
class BookInfoSerializer(serializers.Serializer):
    """图书数据序列化器"""
    id = serializers.IntegerField(label='ID', read_only=True)
    btitle = serializers.CharField(label='名称', max_length=20)
    bpub_date = serializers.DateField(label='发布日期')
    bread = serializers.IntegerField(label='阅读量', required=False)
    bcomment = serializers.IntegerField(label='评论量', required=False)
```

**总结**：
* 序列器类定义：
  * 继承自`serializers.Serializer`
  * 定义字段：`<字段名>=serializers.字段类型(选项参数)`
* 基本使用：
  * 创建序列化器类对象：serializer = <序列化器类>(instance, data, \*\*kwargs)
  * 序列化时，将对象传递给instance
  * 反序列化时，将字典数据传递给data
* 选项参数：
  * write_only：为True，字段只在反序列化时使用
  * read_only：为True，字段只在序列化时使用
  * required：为True，如果字段在反序列化时使用，该字段必传传入
  * default：设置序列化和反序列化操作时的默认值
  * max_length和min_length：设置字符串的最大长度和最小长度
  * max_value和min_value：设置数字的最大值和最小值
