# 外部访问容器

容器中可以运行一些网络应用，要让外部也可以访问这些应用，可以通过 `-P` 或 `-p` 参数来指定端口映射。

当使用 `-P` 标记时，Docker 会随机映射一个 `49000~49900` 的端口到内部容器开放的网络端口。

实际情况我们不会采用此方式，而会使用`-p`

如果要查看一个容器使用的端口以及映射情况，除了可以使用`docker ps`查看以外，还可以使用 `docker container ls` 查看



## 一、准备my_flask镜像

### 1. Dockerfile

```
FROM python:3.6
WORKDIR /home
RUN pip3 install flask -i https://mirrors.aliyun.com/pypi/simple/
CMD ["python3", "app.py"]
```



### 2. 创建app.py

```python
from flask import Flask

app = Flask(__name__)

@app.route('/')
def hello():
    return "<h1>Hello World</h1>"

if __name__ == "__main__":
    app.run(host="0.0.0.0", debug=True)
```



### 3. 创建镜像

```
docker build -t my_flask:1.0 .
```

效果

<img src="assets/image-20201216203541117.png" alt="image-20201216203541117" style="zoom:50%;" />



## 二、网络相关知识

### -p的作用

`-p` 则可以指定要映射的端口，并且，在一个指定端口上只可以绑定一个容器。

支持的格式有:

- `ip:hostPort:containerPort`
- `ip::containerPort`
- `hostPort:containerPort`



### 1. 映射所有接口地址

使用 `hostPort:containerPort` 格式本地的 5000 端口映射到容器的 5000 端口，可以执行

```bash
docker run --rm -it -v 自己电脑的绝对路径:/home -p 5000:5000 my_flask:1.0
```

此时默认会绑定本地所有接口上的所有地址

<img src="assets/image-20201216203826758.png" alt="image-20201216203826758" style="zoom:50%;" />

<img src="assets/image-20201216204011636.png" alt="image-20201216204011636" style="zoom:50%;" />



### 2. 映射到指定地址的指定端口

可以使用 `ip:hostPort:containerPort` 格式指定映射使用一个特定地址，比如 localhost 地址 127.0.0.1

```bash
docker run --rm -it -v 自己电脑的绝对路径:/home -p 127.0.0.1:5000:5000 my_flask:1.0
```

<img src="assets/image-20201216204220065.png" alt="image-20201216204220065" style="zoom:50%;" />



### 3. 映射到指定地址的任意端口

使用 `ip::containerPort` 绑定 localhost 的任意端口到容器的 5000 端口，本地主机会自动分配一个端口。

```bash
docker run --rm -it -v 自己电脑的绝对路径:/home -p :5000 my_flask:1.0
```

<img src="assets/image-20201216204345797.png" alt="image-20201216204345797" style="zoom:50%;" />



还可以使用 `udp` 标记来指定 `udp` 端口

```bash
docker run --rm -it -v 自己电脑的绝对路径:/home -p :5000/udp my_flask:1.0
```

<img src="assets/image-20201216204504479.png" alt="image-20201216204504479" style="zoom:50%;" />



### 4. 查看映射端口配置

使用 `docker port` 来查看当前映射的端口配置，也可以查看到绑定的地址

```bash
$ docker port 容器id
```

<img src="assets/image-20201216204711302.png" alt="image-20201216204711302" style="zoom:50%;" />



注意：

- 容器有自己的内部网络和 ip 地址（使用 `docker inspect` 可以获取所有的变量，Docker 还可以有一个可变的网络配置。）
- `-p` 标记可以多次使用来绑定多个端口

例如

```bash
$ docker run -d -p 5000:5000 -p 3000:80 my_flask:1.0
```