# 查询所有股票信息

## 1. 添加MySQL的操作

### `views/mini_web.py`代码更新如下：

注意：删除了之前无用的一些函数，例如`login`

```python
import time
import re
from contextlib import contextmanager


# 定义一个字典，用来存储 url以及对应的func 的对应关系，key：url， value：func
import pymysql

URL_ROUTE = dict()
# 定义一个全局变量，用来存储 找html页面时的路径
TEMPLATES_PATH = "./templates"


@contextmanager
def mini_open(file_path, model="r"):
    f = open(TEMPLATES_PATH + file_path, model)
    yield f
    f.close()


def route(url):  # "/login.html"
    def set_func(func):  # login函数名
        # 将url与func进行关联，此时就是映射
        URL_ROUTE[url] = func

        def call_func(*args, **kwargs):
            return func(*args, **kwargs)
        return call_func
    return set_func


@route("404")
def page_404(file_path):
    return "404，当前时间是：%s" % time.ctime()


@route("/center.html")
def center(file_path):
    with mini_open(file_path) as f:
        content = f.read()

    return content


@route("/index.html")
def index(file_path):
    with mini_open(file_path) as f:
        content = f.read()

    # -------- 更新 ---------
    # data_from_mysql = "这里模拟的是从MySQL查询出来的数据..."
    db = pymysql.connect(host='localhost', port=3306, user='root', password='python', database='stock_db', charset='utf8')
    cursor = db.cursor()
    sql = """select * from info;"""
    cursor.execute(sql)
    data_from_mysql = cursor.fetchall()
    cursor.close()
    db.close()

    # 通过正则表达式替换html页面数据中的特定模板
    content = re.sub(r"\{% content %\}", str(data_from_mysql), content)

    return content


# 定义一个字典，用url来当做key，用函数的引用当做value
# 这样做，会将 url与之对应的函数 进行关联
# URL_ROUTE = {
#     "/login.py": login,
#     "/logout.py": logout,
#     "/register.py": register,
#     "/detail.py": detail,
#     "404": page_404
# }


def application(env, call_func):
    """
    接收web服务器传递过来的 请求参数
    :param file_path:
    :return:
    """
    # 2. 根据映射的关系即URL_ROUTE这字典，根据不同的url请求调用对应的函数
    # 2.0 提取url中的路径
    file_path = env["PATH_INFO"]  # "/login.html"

    # 2.1 提取函数引用
    # func = URL_ROUTE[file_path]  # login
    func = URL_ROUTE.get(file_path, None)
    if not func:
        # 回调 call_func变量指向的函数，并且将 状态码以及header传递过去
        call_func("404 Not Found", [("Content-Type", "text/html;charset=utf-8"), ("framework", "mini_web")])
        # 如果浏览器请求的url没有在 路由映射字典中找到，那么就返回一个默认的404处理函数
        func = URL_ROUTE.get("404", lambda x: "not found you page ,404")
    else:
        # 回调 call_func变量指向的函数，并且将 状态码以及header传递过去
        call_func("200 OK", [("Content-Type", "text/html;charset=utf-8"), ("framework", "mini_web")])

    # 2.2 调用函数
    response_body = func(file_path)  # response_body = login("/login.html")

    # 2.3 返回数据给web服务器
    return response_body

```

### `templates/index.html`代码更新如下：

```html
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>首页 - 个人选股系统 V5.87</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
<div class="navbar navbar-inverse navbar-static-top ">
    <div class="container">
    <div class="navbar-header">
        <button class="navbar-toggle" data-toggle="collapse" data-target="#mymenu">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
         </button>
         <a href="#" class="navbar-brand">选股系统</a>
    </div>
    <div class="collapse navbar-collapse" id="mymenu">
        <ul class="nav navbar-nav">
            <li class="active"><a href="/index.html">股票信息</a></li>
            <li><a href="/center.html">个人中心</a></li>
        </ul>
    </div>
    </div>
</div>
  <div class="container">

    <div class="container-fluid">

      <table class="table table-hover">
        <tr>
            <th>序号</th>
            <th>股票代码</th>
            <th>股票简称</th>
            <th>涨跌幅</th>
            <th>换手率</th>
            <th>最新价(元)</th>
            <th>前期高点</th>
            <th>前期高点日期</th>
            <th>添加自选</th>
        </tr>
          {% content %} <!--   更新   -->
      </table>
    </div>
  </div>
    <script src="/static/js/bootstrap.min.js"></script>
  </body>
</html>            
```



## 2. 运行效果：

![image-20190424210330761](assets/image-20190424210330761.png)

## 3. 小结

在mini_web框架中通过添加一些MySQL的操作语句，能够完成一些业务的处理

往往这些函数根据业务的不同编写不同的代码