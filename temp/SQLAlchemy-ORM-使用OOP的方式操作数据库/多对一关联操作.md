# SQLAlchemy 多对一关联操作

## 1. 准备

### 创建数据表

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, String, Integer, ForeignKey
from sqlalchemy.orm import sessionmaker, relationship


# 链接是需要指定要用到的MySQL数据库
engine = create_engine('mysql+pymysql://root:python@localhost:3306/py3_sqlalchemy_2019?charset=utf8')
Base = declarative_base()  # 生成SQLORM基类


class Parent(Base):
    __tablename__ = 'parent_table'
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(20))
    # 可以通过parent_table表查child_table,数据库中不会创建children字段,只是建立联系
    # 参数backref相当于给类Child类添加了一个属性，在查询的时候可以通过Child.parents属性获取child_table表关联的所有parent_table表
    childrens = relationship('Child', backref='parents')


class Child(Base):
    __tablename__ = 'child_table'
    id = Column(Integer, primary_key=True,autoincrement=True)
    name = Column(String(20))
    age = Column(Integer)
    parent_id = Column(Integer, ForeignKey('parent_table.id'))


# 创建userinfo表（所有表结构）
Base.metadata.create_all(engine)

```

![image-20180810190226462](assets/05-sqlalchemy/image-20180810190226462.png)

![image-20180810193746348](assets/05-sqlalchemy/image-20180810193746348.png)

![image-20180810193808707](assets/05-sqlalchemy/image-20180810193808707.png)

## 2. 插入数据

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, String, Integer, ForeignKey
from sqlalchemy.orm import sessionmaker, relationship


# 链接是需要指定要用到的MySQL数据库
engine = create_engine('mysql+pymysql://root:python@localhost:3306/py3_sqlalchemy_2019?charset=utf8')
Base = declarative_base()  # 生成SQLORM基类


class Parent(Base):
    __tablename__ = 'parent_table'
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(20))
    # 可以通过parent_table表查child_table,数据库中不会创建children字段,只是建立联系
    # 参数backref相当于给类Child类添加了一个属性，在查询的时候可以通过Child.parents属性获取child_table表关联的所有parent_table表
    childrens = relationship('Child', backref='parents')


class Child(Base):
    __tablename__ = 'child_table'
    id = Column(Integer, primary_key=True,autoincrement=True)
    name = Column(String(20))
    age = Column(Integer)
    parent_id = Column(Integer, ForeignKey('parent_table.id'))


DBSession = sessionmaker(bind=engine)  # 创建与数据库的会话，返回的是一个类
# 创建session对象
session = DBSession()  # 生成链接数据库的实例

p = Parent(name="曹操")
c1 = Child(name="曹丕", age=10, parents=p)
c2 = Child(name="曹植", age=11, parents=p)
c3 = Child(name="曹彰", age=12, parents=p)
c4 = Child(name="曹昂", age=13, parents=p)
c5 = Child(name="曹冲", age=14, parents=p)

session.add_all([p, c1, c2, c3, c4, c5])
session.commit()
session.close()

```

![image-20180810194245352](assets/05-sqlalchemy/image-20180810194245352.png)



## 3. 查询

### 示例1

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, String, Integer, ForeignKey
from sqlalchemy.orm import sessionmaker, relationship


# 链接是需要指定要用到的MySQL数据库
engine = create_engine('mysql+pymysql://root:python@localhost:3306/py3_sqlalchemy_2019?charset=utf8')
Base = declarative_base()  # 生成SQLORM基类


class Parent(Base):
    __tablename__ = 'parent_table'
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(20))
    # 可以通过parent_table表查child_table,数据库中不会创建children字段,只是建立联系
    # 参数backref相当于给类Child类添加了一个属性，在查询的时候可以通过Child.parents属性获取child_table表关联的所有parent_table表
    childrens = relationship('Child', backref='parents')


class Child(Base):
    __tablename__ = 'child_table'
    id = Column(Integer, primary_key=True,autoincrement=True)
    name = Column(String(20))
    age = Column(Integer)
    parent_id = Column(Integer, ForeignKey('parent_table.id'))


DBSession = sessionmaker(bind=engine)  # 创建与数据库的会话，返回的是一个类
# 创建session对象
session = DBSession()  # 生成链接数据库的实例

# 查询出符合条件的一个对象
obj = session.query(Parent).filter(Parent.id == 1).one()
print(obj.childrens)
# 通过对象属性children，查出这个对象的所有关联age字段值
for temp in obj.childrens:
    print(temp.name, temp.age)

session.close()

```



![image-20180810194617223](assets/05-sqlalchemy/image-20180810194617223.png)

### 示例2

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, String, Integer, ForeignKey
from sqlalchemy.orm import sessionmaker, relationship


# 链接是需要指定要用到的MySQL数据库
engine = create_engine('mysql+pymysql://root:python@localhost:3306/py3_sqlalchemy_2019?charset=utf8')
Base = declarative_base()  # 生成SQLORM基类


class Parent(Base):
    __tablename__ = 'parent_table'
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(20))
    # 可以通过parent_table表查child_table,数据库中不会创建children字段,只是建立联系
    # 参数backref相当于给类Child类添加了一个属性，在查询的时候可以通过Child.parents属性获取child_table表关联的所有parent_table表
    childrens = relationship('Child', backref='parents')


class Child(Base):
    __tablename__ = 'child_table'
    id = Column(Integer, primary_key=True,autoincrement=True)
    name = Column(String(20))
    age = Column(Integer)
    parent_id = Column(Integer, ForeignKey('parent_table.id'))


DBSession = sessionmaker(bind=engine)  # 创建与数据库的会话，返回的是一个类
# 创建session对象
session = DBSession()  # 生成链接数据库的实例

# 查询出符合条件的一个对象
obj = session.query(Child).filter(Child.id == 2).one()
# 打印对象中的关联
print(obj.parents.name)

session.close()

```

![image-20180810194836248](assets/05-sqlalchemy/image-20180810194836248.png)

### 示例3

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, String, Integer, ForeignKey
from sqlalchemy.orm import sessionmaker, relationship


# 链接是需要指定要用到的MySQL数据库
engine = create_engine('mysql+pymysql://root:python@localhost:3306/py3_sqlalchemy_2019?charset=utf8')
Base = declarative_base()  # 生成SQLORM基类


class Parent(Base):
    __tablename__ = 'parent_table'
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(20))
    # 可以通过parent_table表查child_table,数据库中不会创建children字段,只是建立联系
    # 参数backref相当于给类Child类添加了一个属性，在查询的时候可以通过Child.parents属性获取child_table表关联的所有parent_table表
    childrens = relationship('Child', backref='parents')
    
    def __repr__(self):
        return "'id:%d,name=%s'" % (self.id, self.name)


class Child(Base):
    __tablename__ = 'child_table'
    id = Column(Integer, primary_key=True,autoincrement=True)
    name = Column(String(20))
    age = Column(Integer)
    parent_id = Column(Integer, ForeignKey('parent_table.id'))
    
    def __repr__(self):
        return "'id=%d,name=%s,age=%d'" % (self.id, self.name, self.age)


DBSession = sessionmaker(bind=engine)  # 创建与数据库的会话，返回的是一个类
# 创建session对象
session = DBSession()  # 生成链接数据库的实例

# 内关联查询出Parent.id == Child.parent_id的结果
q6 = session.query(Parent).join(Child).filter(Parent.id == Child.parent_id).all()
print(q6)

print("-" * 20)

# 内关联查询出Parent.id == Child.parent_id的结果
q6 = session.query(Child).join(Parent).filter(Parent.id == Child.parent_id).all()
print(q6)
# for temp in q6:
#     print(type(temp))
#     print(temp.name, temp.age)

print("-" * 20)

# 内关联查询出Parent.id == Child.parent_id的结果
q6 = session.query(Parent, Child).join(Child).filter(Parent.id == Child.parent_id).all()
print(q6)
# for p, c in q6:
#     print(p.name, c.name, c.age)

session.close()

```

![image-20190506202226426](assets/image-20190506202226426.png)


## 4. relationship放到另外一张表


```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, String, Integer, ForeignKey
from sqlalchemy.orm import sessionmaker, relationship


# 链接是需要指定要用到的MySQL数据库
engine = create_engine('mysql+pymysql://root:python@localhost:3306/py3_sqlalchemy_2019?charset=utf8')
Base = declarative_base()  # 生成SQLORM基类


# 一对多
class Group(Base):
    __tablename__ = 'group'
    id = Column(Integer, primary_key=True, autoincrement=True)
    caption = Column(String(32))


class User(Base):
    __tablename__ = 'user'
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(32))
    group_id = Column(Integer, ForeignKey('group.id'))
    # 虚拟创建关系,relationship  一般是跟foreignkey 在一起使用
    group = relationship("Group", backref='users')

    # 自定义输出方式
    def __repr__(self):
        temp = '%s-%s:%s' % (self.id, self.name, self.group_id)
        return temp


# 创建对应数据表
# Base.metadata.create_all(engine)

# 创建与数据库的会话，返回的是一个类
DBSession = sessionmaker(bind=engine)
# 创建session对象
session = DBSession()  # 生成链接数据库的实例

# 插入数据
g1 = Group(caption='研发')
g2 = Group(caption='测试')
session.add_all([g1, g2])

session.add_all([
    User(name='老王', group=g1),
    User(name='老闫', group=g1),
    User(name='老马', group=g2),
    User(name='老叶', group=g2)
])

session.commit()
session.close()

```

### 新建数据表

![image-20180811113222297](assets/05-sqlalchemy/image-20180811113222297.png)

### 查询的结果

![image-20180811113149538](assets/05-sqlalchemy/image-20180811113149538.png)

## 5. 总计

![image-20190506203132060](assets/image-20190506203132060.png)