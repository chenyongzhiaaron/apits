# 数据库迁移

## 1. Alembic简介

SQLAlchemy是一款非常优秀的ORM框架，但是本身没有带数据库版本控制功能，这很不方便，进行开发过程中难免修改数据模型，添加一个表，修改一个字段，都需要手动修改的话就比较费事了，还不如不用SQLAlchemy呢。

这里介绍一款SQLAlchemy作者写的数据库版本控制工具`Alembic`。另外还有一个工具叫做`SQLAlchemy-Migrate`，在使用过程中`Alembic`更为灵活。

#### 安装alembic

```shell
pip3 install alembic
```

## 2. 初始化

使用之前，先在项目根目录进行初始化。

```shell
$ alembic init sqlalchemy_test
```

初始化完成后，会生成一个alembic.ini配置文件及一个sqlalchemy_test目录

![image-20180811145619236](assets/05-sqlalchemy/image-20180811145619236.png)

####  项目目录树

![image-20180811145656625](assets/05-sqlalchemy/image-20180811145656625.png)

## 3. 建立模型

#### 建立一个文件夹以及文件用来存放模型

![image-20180811150957491](assets/05-sqlalchemy/image-20180811150957491.png)

#### 在`model.py`文件中的模型

> 仅写模型即可

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, String, Integer, ForeignKey
from sqlalchemy.orm import sessionmaker, relationship

Base = declarative_base()  # 生成SQLORM基类


# 多对多
class HostToHostUser(Base):
    __tablename__ = 'host_to_host_user'
    nid = Column(Integer, primary_key=True,autoincrement=True)

    host_id = Column(Integer,ForeignKey('host.nid'))
    host_user_id = Column(Integer,ForeignKey('host_user.nid'))
    # # 多对多操作
    # host = relationship('Host', backref='h')
    # host_user = relationship('HostUser', backref='u')


class Host(Base):
    __tablename__ = 'host'
    nid = Column(Integer, primary_key=True,autoincrement=True)
    hostname = Column(String(32))
    port = Column(String(32))
    ip = Column(String(32))
    ####最简单的方式,添加此行就行:
    host_user = relationship('HostUser',secondary=HostToHostUser.__table__, backref='host')


class HostUser(Base):
    __tablename__ = 'host_user'
    nid = Column(Integer, primary_key=True,autoincrement=True)
    username = Column(String(32))
```



## 4. 修改配置文件

#### 修改alembic.ini配置文件

只修改数据库连接部分即可，

将

```python
sqlalchemy.url = driver://user:pass@localhost:port/dbname
```

修改为

```python
sqlalchemy.url = mysql+pymysql://root:@localhost/linux_study
```

![image-20180811150523821](assets/05-sqlalchemy/image-20180811150523821.png)

#### 修改alembic/env.py

将

```python
target_metadata = None
```

修改为

```python
import sys                                             
from os.path import abspath, dirname                   
sys.path.append(dirname(dirname(abspath(__file__))))   
from models.model import Base                        
target_metadata = Base.metadata                        
```

![image-20180811150323475](assets/05-sqlalchemy/image-20180811150323475.png)

## 5. 自动创建版本

使用`alembic revision -m "注释" `创建数据库版本，上面我们修改了配置文件`alembic/env.py`，指定了`target_metadata`，这里可以使用`--autogenerate`参数自动生成迁移脚本

```shell
$ alembic revision --autogenerate -m "initdb"
```

![image-20180811151033888](assets/05-sqlalchemy/image-20180811151033888.png)

![image-20180811151151641](assets/05-sqlalchemy/image-20180811151151641.png)

#### 开始迁移

![image-20180811151520424](assets/05-sqlalchemy/image-20180811151520424.png)

![image-20180811151547634](assets/05-sqlalchemy/image-20180811151547634.png)

![image-20180811151626946](assets/05-sqlalchemy/image-20180811151626946.png)

## 6. 更新数据库

![image-20180811151752887](assets/05-sqlalchemy/image-20180811151752887.png)

![image-20180811151832064](assets/05-sqlalchemy/image-20180811151832064.png)

## 其他常用参数

**更新数据库**

```
$ alembic upgrade 版本号
```

**更新到最新版**

```
alembic upgrade head
```

**降级数据库**

```
$ alembic downgrade 版本号
```

**更新到最初版**

```
alembic downgrade head
```

**离线更新（生成sql）**

```
alembic upgrade 版本号 --sql > migration.sql
```

**从特定起始版本生成sql**

```
alembic upgrade 版本一:版本二 --sql > migration.sql
```

**查询当前数据库版本号**

查看alembic_version表。

**清除所有版本**

将versions删掉，并删除alembic_version表